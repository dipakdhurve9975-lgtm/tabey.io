<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SANGHX ‚Ä¢ Secure Checkout üî•</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

<style>
  :root{
    --primary:#FF4B3A;
    --dark:#121212;
    --gray:#F5F5F8;
    --white:#ffffff;

    --saffron:#FF9933;
    --green:#138808;
    --chakra:#000080;

    --shadow-sm:0 6px 14px rgba(0,0,0,0.06);
    --shadow-md:0 12px 28px rgba(0,0,0,0.10);
    --shadow-lg:0 22px 60px rgba(0,0,0,0.16);
  }

  *{margin:0;padding:0;box-sizing:border-box;font-family:'Outfit',sans-serif;-webkit-tap-highlight-color:transparent;}
  body{
    background:var(--gray);
    color:var(--dark);
    padding-bottom:140px;
    overflow-x:hidden;
    position:relative;
  }

  /* üáÆüá≥ Flag background */
  .flag-bg{
    position:fixed; inset:0; z-index:-10; overflow:hidden;
  }
  .flag-bg::before{
    content:"";
    position:absolute; inset:-60px;
    background:
      radial-gradient(circle at 20% 20%, rgba(255,153,51,0.22) 0%, transparent 42%),
      radial-gradient(circle at 80% 80%, rgba(19,136,8,0.22) 0%, transparent 42%),
      radial-gradient(circle at 50% 50%, rgba(0,0,128,0.14) 0%, transparent 50%),
      linear-gradient(
        to bottom,
        rgba(255,153,51,0.18) 0%,
        rgba(255,153,51,0.10) 33%,
        rgba(255,255,255,0.10) 33%,
        rgba(255,255,255,0.10) 66%,
        rgba(19,136,8,0.10) 66%,
        rgba(19,136,8,0.18) 100%
      );
    animation: waveFlag 7s ease-in-out infinite;
    transform-origin:center;
  }
  @keyframes waveFlag{
    0%{transform:skewX(0deg) translateX(0px) scale(1.1);}
    25%{transform:skewX(-2deg) translateX(-10px) scale(1.1);}
    50%{transform:skewX(2deg) translateX(10px) scale(1.1);}
    75%{transform:skewX(-2deg) translateX(-8px) scale(1.1);}
    100%{transform:skewX(0deg) translateX(0px) scale(1.1);}
  }

  .chakra{
    position:absolute;
    left:50%; top:50%;
    transform:translate(-50%,-50%);
    width:520px; height:520px;
    border-radius:50%;
    border:18px solid rgba(0,0,128,0.07);
    opacity:0.35;
    animation: megaSpin 18s linear infinite;
  }
  @keyframes megaSpin{
    from{transform:translate(-50%,-50%) rotate(0deg);}
    to{transform:translate(-50%,-50%) rotate(360deg);}
  }

  header{
    position:sticky; top:0; z-index:100;
    background:rgba(255,255,255,0.88);
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
    padding:16px 18px;
    border-bottom:1px solid rgba(0,0,0,0.06);
    display:flex; align-items:center; justify-content:space-between;
    box-shadow:0 12px 30px rgba(255,153,51,0.10);
  }
  .brand{
    font-size:24px;
    font-weight:900;
    letter-spacing:-1px;
  }
  .brand span{color:var(--primary);}
  .back-btn{
    width:44px;height:44px;border-radius:16px;
    display:flex;align-items:center;justify-content:center;
    background:#111;color:white;
    text-decoration:none;
    box-shadow:0 16px 45px rgba(0,0,0,0.25);
  }
  .back-btn:active{transform:scale(.92);}

  .container{
    max-width:620px;
    margin:0 auto;
    padding:18px;
  }

  .title{
    font-size:26px;
    font-weight:900;
    margin-bottom:10px;
  }
  .sub{
    opacity:.75;
    font-weight:700;
    margin-bottom:18px;
  }

  .card{
    background:white;
    border-radius:26px;
    box-shadow:var(--shadow-md);
    padding:16px;
    margin-bottom:16px;
    border:2px solid rgba(0,0,0,0.04);
  }

  .sec-title{
    font-weight:900;
    font-size:15px;
    margin-bottom:12px;
    display:flex;align-items:center;gap:8px;
  }

  .row{
    display:flex;
    gap:10px;
  }

  input, textarea, select{
    width:100%;
    padding:14px 14px;
    border-radius:16px;
    border:2px solid #eee;
    outline:none;
    font-weight:800;
    background:#fff;
    transition:.2s;
    font-size:15px;
  }
  textarea{
    min-height:84px;
    resize:none;
    font-weight:700;
  }
  input:focus, textarea:focus, select:focus{
    border-color:var(--primary);
    box-shadow:0 14px 40px rgba(255,75,58,0.18);
  }

  .gps-box{
    display:flex;
    gap:10px;
    align-items:center;
  }

  .gps-btn{
    flex:1;
    border:none;
    cursor:pointer;
    border-radius:18px;
    padding:14px 14px;
    font-weight:900;
    font-size:14px;
    background:linear-gradient(135deg,#111,#2a2a2a);
    color:#fff;
    box-shadow:0 16px 45px rgba(0,0,0,0.18);
    transition:.2s;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .gps-btn:active{transform:scale(.98);}
  .gps-btn.active{
    background:linear-gradient(135deg,#2ed573,#00d2a0);
  }

  .gps-status{
    margin-top:10px;
    font-weight:900;
    font-size:12px;
    opacity:.8;
    text-align:center;
  }

  .km-pill{
    display:none;
    margin-top:10px;
    padding:10px 14px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    width:max-content;
    max-width:100%;
    border:2px solid #eee;
  }
  .km-pill.ok{
    display:inline-flex;
    background:#eafff2;
    border-color:#b8f0d0;
    color:#0f7a3b;
  }
  .km-pill.no{
    display:inline-flex;
    background:#fff1f1;
    border-color:#ffd0d0;
    color:#b10000;
  }

  .cart-box{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .store-block{
    background:linear-gradient(135deg,#fff,#fafafa);
    border-radius:22px;
    padding:14px;
    border:2px dashed rgba(255,153,51,0.22);
  }

  .store-head{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:10px;
  }
  .store-name{
    font-weight:900;
    font-size:16px;
  }
  .pill{
    font-size:11px;
    font-weight:900;
    padding:6px 12px;
    border-radius:999px;
    background:rgba(0,0,0,0.06);
  }

  .item-row{
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 0;
    border-bottom:1px solid #f2f2f2;
    gap:10px;
  }
  .item-row:last-child{border-bottom:none;}
  .it-name{font-weight:900;}
  .it-sub{opacity:.7;font-weight:800;font-size:12px;}
  .it-price{font-weight:900;}

  .bill{
    background:#f9f9fb;
    border-radius:22px;
    padding:14px;
    border:2px dashed rgba(19,136,8,0.25);
  }
  .bill-row{
    display:flex;justify-content:space-between;
    margin-bottom:8px;
    font-weight:800;
    color:#666;
  }
  .bill-total{
    display:flex;justify-content:space-between;
    font-weight:900;
    font-size:18px;
    margin-top:10px;
    color:#111;
  }

  .btn{
    width:100%;
    padding:16px;
    border:none;
    border-radius:20px;
    font-weight:900;
    font-size:15px;
    cursor:pointer;
    letter-spacing:.5px;
    box-shadow:0 18px 50px rgba(0,0,0,0.12);
    transition:.18s;
  }
  .btn:active{transform:scale(.98);}
  .btn-primary{
    background:linear-gradient(135deg,#2ed573,#00d2a0);
    color:white;
  }
  .btn-primary:disabled{
    opacity:.55;
    cursor:not-allowed;
    filter:grayscale(1);
    box-shadow:none;
  }

  /* toast */
  .toast{
    position:fixed;
    top:92px;left:50%;
    transform:translateX(-50%) scale(.92);
    background:rgba(18,18,18,0.92);
    color:white;
    padding:14px 20px;
    border-radius:999px;
    font-weight:900;
    opacity:0;
    pointer-events:none;
    transition:.28s cubic-bezier(.68,-0.55,.265,1.55);
    z-index:9999;
    display:flex;align-items:center;gap:10px;
    box-shadow:0 16px 50px rgba(0,0,0,0.25);
  }
  .toast.show{opacity:1;transform:translateX(-50%) scale(1);}

  /* UPI QR Modal */
  .modal{
    position:fixed; inset:0;
    display:none;
    align-items:flex-end;
    justify-content:center;
    z-index:99999;
    background:rgba(0,0,0,0.55);
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
  }
  .modal.show{display:flex;}
  .modal-card{
    width:100%;
    max-width:620px;
    background:white;
    border-radius:28px 28px 0 0;
    padding:18px;
    box-shadow:0 -20px 80px rgba(0,0,0,0.25);
    transform:translateY(110%);
    animation:popUp .45s cubic-bezier(.68,-0.55,.265,1.55) forwards;
  }
  @keyframes popUp{ to{transform:translateY(0);} }

  .qrbox{
    background:linear-gradient(135deg,#fff,#fafafa);
    border:2px dashed rgba(0,0,0,0.12);
    border-radius:22px;
    padding:16px;
    text-align:center;
  }
  .qrbox img{
    width:220px;
    height:220px;
    border-radius:20px;
    object-fit:cover;
    background:#eee;
  }
  .close-x{
    width:42px;height:42px;border-radius:14px;
    background:#111;color:white;
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;
  }

  /* Delivery Fee Table */
  .fee-table{
    margin-top:12px;
    background:linear-gradient(135deg,#fff8f0,#fff);
    border-radius:16px;
    padding:12px;
    border:2px solid rgba(255,153,51,0.2);
  }
  .fee-row{
    display:flex;
    justify-content:space-between;
    padding:8px 0;
    border-bottom:1px dashed #eee;
    font-weight:800;
    font-size:13px;
  }
  .fee-row:last-child{border-bottom:none;}
  .fee-row .km{color:#666;}
  .fee-row .price{color:#0f7a3b;font-weight:900;}
  .fee-row.active{
    background:rgba(46,213,115,0.15);
    border-radius:10px;
    padding:8px 10px;
    margin:0 -10px;
  }
  .fee-row.active .km,
  .fee-row.active .price{color:#0f7a3b;}
</style>
</head>

<body>

<div class="flag-bg">
  <div class="chakra"></div>
</div>

<header>
  <a class="back-btn" href="customer.html" title="Back">
    <i class='bx bx-left-arrow-alt' style="font-size:26px;"></i>
  </a>
  <div class="brand">SAN<span>GHX</span></div>
  <a class="back-btn" href="https://wa.me/918087762813" target="_blank" title="Help">
    <i class='bx bxl-whatsapp' style="font-size:22px;"></i>
  </a>
</header>

<div class="container">
  <div class="title">Checkout üöÄ</div>
  <div class="sub">GPS attach karo, tabhi order send hoga üî•</div>

  <div class="card">
    <div class="sec-title"><i class='bx bxs-user'></i> Customer Details</div>
    <div class="row">
      <input id="cName" placeholder="Your Name">
      <input id="cMobile" placeholder="Mobile Number" inputmode="numeric">
    </div>
    <div style="height:10px;"></div>
    <textarea id="cAddress" placeholder="Full Address (House no, area, landmark)"></textarea>
  </div>

  <div class="card">
    <div class="sec-title"><i class='bx bxs-map'></i> Location (Required)</div>

    <div class="gps-box">
      <button class="gps-btn" id="gpsBtn">
        <i class='bx bxs-navigation'></i> Detect My Location
      </button>
    </div>

    <div id="gpsStatus" class="gps-status">‚ö†Ô∏è Location required to place order (10KM limit)</div>
    <div id="kmPill" class="km-pill"></div>

    <!-- Delivery Fee Table -->
    <div class="fee-table">
      <div class="fee-row" id="feeRow1">
        <span class="km">üìç 0 - 4 KM</span>
        <span class="price">‚Çπ10</span>
      </div>
      <div class="fee-row" id="feeRow2">
        <span class="km">üìç 5 - 7 KM</span>
        <span class="price">‚Çπ25</span>
      </div>
      <div class="fee-row" id="feeRow3">
        <span class="km">üìç 8 - 10 KM</span>
        <span class="price">‚Çπ40</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="sec-title"><i class='bx bxs-wallet'></i> Payment Mode</div>
    <select id="payMode">
      <option value="UPI">UPI (Scan QR)</option>
      <option value="COD">Cash On Delivery</option>
    </select>
    <div style="height:10px;"></div>
    <button class="btn" style="background:linear-gradient(135deg,#111,#2a2a2a);color:#fff;" id="upiBtn">
      Show UPI QR üî•
    </button>
  </div>

  <div class="card">
    <div class="sec-title"><i class='bx bxs-shopping-bag'></i> Your Items</div>
    <div class="cart-box" id="cartBox"></div>
  </div>

  <div class="card">
    <div class="sec-title"><i class='bx bxs-receipt'></i> Bill Summary</div>
    <div class="bill">
      <div class="bill-row"><span>Subtotal</span><span id="subTotal">‚Çπ0</span></div>
      <div class="bill-row"><span>Delivery Fee</span><span id="delFee">Attach GPS</span></div>
      <div class="bill-total"><span>Grand Total</span><span id="grandTotal">‚Çπ0</span></div>
    </div>
  </div>

  <button class="btn btn-primary" id="placeOrderBtn" disabled>
    Place Order on WhatsApp üöÄ
  </button>
</div>

<div class="toast" id="toast"><i class='bx bxs-check-circle'></i> Done</div>

<!-- UPI MODAL -->
<div class="modal" id="upiModal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="font-weight:900;font-size:16px;">UPI Payment üî•</div>
      <div class="close-x" id="upiClose"><i class='bx bx-x' style="font-size:26px;"></i></div>
    </div>

    <div class="qrbox">
      <img id="qrImg" src="" alt="UPI QR">
      <div style="margin-top:10px;font-weight:900;">Scan & Pay</div>
      <div style="opacity:.7;font-weight:800;font-size:12px;margin-top:6px;">
        Payment done? Then click Place Order üöÄ
      </div>
    </div>

    <div style="height:12px;"></div>
    <button class="btn" style="background:#111;color:#fff;" id="copyUpiBtn">Copy UPI ID</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // üî• Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyC-igyzVwdH_4Jt1r64TtHSfYxIMw8UfzM",
    authDomain: "sanghx-foods.firebaseapp.com",
    projectId: "sanghx-foods",
    storageBucket: "sanghx-foods.firebasestorage.app",
    messagingSenderId: "491353757911",
    appId: "1:491353757911:web:40752459b5b0049c71f892"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== SETTINGS
  const ADMIN_WA = "919322586177";
  const UPI_ID = "samyaksangode0-2@okicici";
  const UPI_NAME = "SANGHX";

  // üî• YOUR STORE/CENTER LOCATION - UPDATED!
  const CENTER_LAT = 21.093938;
  const CENTER_LNG = 80.001430;
  const MAX_KM = 10;

  // üî• DELIVERY FEE ESTIMATOR FUNCTION
  function getDeliveryFeeByKm(km){
    // Round to nearest integer for cleaner calculation
    const roundedKm = Math.round(km);
    
    if(roundedKm >= 0 && roundedKm <= 4){
      return { fee: 10, slab: "0-4 KM", row: 1 };
    }
    if(roundedKm >= 5 && roundedKm <= 7){
      return { fee: 25, slab: "5-7 KM", row: 2 };
    }
    if(roundedKm >= 8 && roundedKm <= 10){
      return { fee: 40, slab: "8-10 KM", row: 3 };
    }
    return null; // Out of range
  }

  // ===== Refs
  const cartBox = document.getElementById("cartBox");
  const subTotalEl = document.getElementById("subTotal");
  const delFeeEl = document.getElementById("delFee");
  const grandTotalEl = document.getElementById("grandTotal");

  const cName = document.getElementById("cName");
  const cMobile = document.getElementById("cMobile");
  const cAddress = document.getElementById("cAddress");

  const payMode = document.getElementById("payMode");
  const upiBtn = document.getElementById("upiBtn");
  const placeOrderBtn = document.getElementById("placeOrderBtn");

  const toast = document.getElementById("toast");

  const upiModal = document.getElementById("upiModal");
  const upiClose = document.getElementById("upiClose");
  const copyUpiBtn = document.getElementById("copyUpiBtn");

  const gpsBtn = document.getElementById("gpsBtn");
  const gpsStatus = document.getElementById("gpsStatus");
  const kmPill = document.getElementById("kmPill");

  const feeRow1 = document.getElementById("feeRow1");
  const feeRow2 = document.getElementById("feeRow2");
  const feeRow3 = document.getElementById("feeRow3");

  // ===== State
  let deliveryFee = 0;
  let userLocLink = "";
  let userDistanceKm = null;

  // ===== Helpers
  function showToast(msg){
    toast.innerHTML = `<i class='bx bxs-check-circle'></i> ${msg}`;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 1400);
  }

  function money(n){ return "‚Çπ" + Number(n||0).toFixed(0); }

  function toRad(v){ return (v * Math.PI) / 180; }

  // üî• Haversine Formula for accurate distance calculation
  function calcDistanceKm(lat1, lon1, lat2, lon2){
    const R = 6371; // Earth's radius in km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function getCart(){
    try{
      const raw = localStorage.getItem("cart");
      if(!raw) return [];
      return JSON.parse(raw) || [];
    }catch(e){
      return [];
    }
  }

  function groupByStore(items){
    const by = {};
    items.forEach(it=>{
      const st = it.storeName || it.vendor || it.shop || "SANGHX";
      if(!by[st]) by[st]=[];
      by[st].push(it);
    });
    return by;
  }

  function calcSubtotal(items){
    return items.reduce((sum,it)=>sum + (Number(it.price||0) * Number(it.qty||0)), 0);
  }

  // üî• Highlight active fee row
  function highlightFeeRow(rowNum){
    feeRow1.classList.remove("active");
    feeRow2.classList.remove("active");
    feeRow3.classList.remove("active");

    if(rowNum === 1) feeRow1.classList.add("active");
    if(rowNum === 2) feeRow2.classList.add("active");
    if(rowNum === 3) feeRow3.classList.add("active");
  }

  function renderCart(){
    const items = getCart();
    cartBox.innerHTML = "";

    if(items.length===0){
      cartBox.innerHTML = `<div style="font-weight:900;opacity:.7;">Cart is empty üò≠</div>`;
      subTotalEl.innerText = money(0);
      delFeeEl.innerText = "Attach GPS";
      grandTotalEl.innerText = money(0);
      placeOrderBtn.disabled = true;
      return;
    }

    const byStore = groupByStore(items);

    Object.keys(byStore).forEach(store=>{
      const storeItems = byStore[store];
      const count = storeItems.reduce((a,b)=>a+b.qty,0);

      const block = document.createElement("div");
      block.className = "store-block";

      block.innerHTML = `
        <div class="store-head">
          <div class="store-name">üè™ ${store}</div>
          <div class="pill">${count} items</div>
        </div>
      `;

      storeItems.forEach(it=>{
        const row = document.createElement("div");
        row.className = "item-row";
        row.innerHTML = `
          <div>
            <div class="it-name">${it.name}</div>
            <div class="it-sub">Qty: ${it.qty} ‚Ä¢ ${money(it.price)}</div>
          </div>
          <div class="it-price">${money(it.price * it.qty)}</div>
        `;
        block.appendChild(row);
      });

      cartBox.appendChild(block);
    });

    const sub = calcSubtotal(items);
    subTotalEl.innerText = money(sub);

    if(userDistanceKm === null){
      delFeeEl.innerText = "Attach GPS";
      grandTotalEl.innerText = money(sub);
      placeOrderBtn.disabled = true;
      highlightFeeRow(0);
      return;
    }

    if(userDistanceKm > MAX_KM){
      delFeeEl.innerText = "Out of Range ‚ùå";
      grandTotalEl.innerText = money(sub);
      placeOrderBtn.disabled = true;
      highlightFeeRow(0);
      return;
    }

    const feeData = getDeliveryFeeByKm(userDistanceKm);
    if(feeData === null){
      delFeeEl.innerText = "Out of Range ‚ùå";
      grandTotalEl.innerText = money(sub);
      placeOrderBtn.disabled = true;
      highlightFeeRow(0);
      return;
    }

    deliveryFee = feeData.fee;
    delFeeEl.innerText = `${money(deliveryFee)} (${feeData.slab})`;
    grandTotalEl.innerText = money(sub + deliveryFee);
    placeOrderBtn.disabled = false;
    highlightFeeRow(feeData.row);
  }

  function showKm(ok, km){
    const feeData = getDeliveryFeeByKm(km);
    kmPill.style.display = "inline-flex";
    kmPill.className = "km-pill " + (ok ? "ok" : "no");
    
    if(ok && feeData){
      kmPill.innerHTML = `‚úÖ ${km.toFixed(2)} KM ‚Ä¢ Delivery: ‚Çπ${feeData.fee}`;
    }else{
      kmPill.innerHTML = `‚ùå ${km.toFixed(2)} KM ‚Ä¢ Out of Range`;
    }
  }

  // ===== GPS
  gpsBtn.addEventListener("click", ()=>{
    gpsBtn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Detecting...";
    gpsBtn.classList.remove("active");

    if(!navigator.geolocation){
      showToast("GPS not supported üò≠");
      gpsBtn.innerHTML = "<i class='bx bxs-navigation'></i> Detect My Location";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        userLocLink = `https://www.google.com/maps?q=${lat},${lng}`;
        userDistanceKm = calcDistanceKm(lat, lng, CENTER_LAT, CENTER_LNG);

        gpsBtn.innerHTML = "<i class='bx bxs-check-circle'></i> Location Attached";
        gpsBtn.classList.add("active");

        if(userDistanceKm <= MAX_KM){
          const feeData = getDeliveryFeeByKm(userDistanceKm);
          gpsStatus.innerHTML = `‚úÖ Distance: <strong>${userDistanceKm.toFixed(2)} KM</strong> ‚Ä¢ Fee: <strong>‚Çπ${feeData.fee}</strong>`;
          gpsStatus.style.color = "green";
          showKm(true, userDistanceKm);
          showToast(`GPS attached! ${userDistanceKm.toFixed(1)}km üî•`);
        }else{
          gpsStatus.innerText = `‚ùå Sorry! We deliver only within ${MAX_KM}KM`;
          gpsStatus.style.color = "red";
          showKm(false, userDistanceKm);
          showToast("Out of range üò≠");
        }

        renderCart();
      },
      (err)=>{
        console.log(err);
        gpsBtn.innerHTML = "‚ùå Permission Denied";
        gpsStatus.innerText = "‚ùå Location required (Allow GPS)";
        gpsStatus.style.color = "red";
        userLocLink = "";
        userDistanceKm = null;
        renderCart();
        showToast("Allow GPS first ‚ö†Ô∏è");
      },
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
    );
  });

  // ===== UPI QR
  function openUpiModal(){
    const items = getCart();
    const sub = calcSubtotal(items);

    if(userDistanceKm === null){
      showToast("Attach GPS first ‚ö†Ô∏è");
      return;
    }
    if(userDistanceKm > MAX_KM){
      showToast("Out of range üò≠");
      return;
    }

    const feeData = getDeliveryFeeByKm(userDistanceKm);
    if(!feeData){
      showToast("Delivery not available üò≠");
      return;
    }

    deliveryFee = feeData.fee;
    const total = sub + deliveryFee;

    const upiUrl = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent(UPI_NAME)}&am=${encodeURIComponent(total)}&tn=${encodeURIComponent("SANGHX Order")}&cu=INR`;

    document.getElementById("qrImg").src =
      `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(upiUrl)}`;

    upiModal.classList.add("show");
  }

  upiBtn.addEventListener("click", openUpiModal);
  upiClose.addEventListener("click", ()=> upiModal.classList.remove("show"));
  upiModal.addEventListener("click",(e)=>{ if(e.target===upiModal) upiModal.classList.remove("show"); });

  copyUpiBtn.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(UPI_ID);
      showToast("UPI copied üî•");
    }catch(e){
      showToast("Copy not supported üò≠");
    }
  });

  // ===== Place Order
  placeOrderBtn.addEventListener("click", async ()=>{
    const items = getCart();
    if(items.length===0){
      showToast("Cart empty üò≠");
      return;
    }

    const name = cName.value.trim();
    const mobile = cMobile.value.trim();
    const addr = cAddress.value.trim();

    if(!name || !mobile || !addr){
      showToast("Fill all details ‚ö†Ô∏è");
      return;
    }

    if(!userLocLink || userDistanceKm === null){
      showToast("Attach GPS first ‚ö†Ô∏è");
      return;
    }

    if(userDistanceKm > MAX_KM){
      showToast(`Only within ${MAX_KM}KM üò≠`);
      return;
    }

    const feeData = getDeliveryFeeByKm(userDistanceKm);
    if(!feeData){
      showToast("Delivery not available üò≠");
      return;
    }

    deliveryFee = feeData.fee;
    const sub = calcSubtotal(items);
    const total = sub + deliveryFee;

    const byStore = groupByStore(items);

    let msg = `*üî• NEW ORDER ALERT üî•*%0a%0a`;
    msg += `üë§ *${name}*%0a`;
    msg += `üìû ${mobile}%0a`;
    msg += `üè† ${addr}%0a%0a`;
    msg += `üìç Distance: *${userDistanceKm.toFixed(2)} KM* (${feeData.slab})%0a`;
    msg += `üó∫ Location: ${userLocLink}%0a%0a`;

    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0a`;
    msg += `*üì¶ ORDER ITEMS:*%0a`;
    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0a`;
    
    Object.keys(byStore).forEach(store=>{
      msg += `%0aüè™ *${store}*%0a`;
      byStore[store].forEach(it=>{
        const variantLabel = it.variantLabel || it.variant || "Regular";
        msg += `  ‚Ä¢ ${it.qty}x ${it.name} (${variantLabel}) - ‚Çπ${it.price * it.qty}%0a`;
      });
    });

    msg += `%0a‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0a`;
    msg += `üßæ Subtotal: ‚Çπ${sub}%0a`;
    msg += `üöö Delivery (${feeData.slab}): ‚Çπ${deliveryFee}%0a`;
    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0a`;
    msg += `üí∞ *TOTAL: ‚Çπ${total}*%0a`;
    msg += `üí≥ Payment: *${payMode.value}*%0a%0a`;
    msg += `‚ö° Please confirm order üôè`;

    // Save to Firebase
    try{
      await addDoc(collection(db, "orders"), {
        customer: {
          name,
          mobile,
          address: addr,
          location: userLocLink,
          distanceKm: Number(userDistanceKm.toFixed(2))
        },
        items: items.map(it=>({
          name: it.name,
          qty: it.qty,
          price: Number(it.price),
          storeName: it.storeName || it.vendor || "SANGHX",
          variantLabel: it.variantLabel || it.variant || "Regular"
        })),
        bill: { 
          subtotal: sub, 
          delivery: deliveryFee, 
          deliverySlab: feeData.slab,
          total 
        },
        payment: payMode.value,
        status: "Pending",
        timestamp: serverTimestamp()
      });

      showToast("Order saved ‚úÖ");
    }catch(e){
      console.log(e);
      showToast("Sending to WhatsApp...");
    }

    // Clear cart
    localStorage.removeItem("cart");

    // Redirect to WhatsApp
    setTimeout(()=>{
      window.location.href = `https://wa.me/${ADMIN_WA}?text=${msg}`;
    }, 500);
  });

  // Initial render
  renderCart();
</script>

</body>
</html>
