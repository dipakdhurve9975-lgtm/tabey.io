<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TABEY • Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  
  <style>
    :root { --primary: #4F46E5; --light: #F9FAFB; --dark: #111827; --white: #ffffff; --sidebar-width: 260px; }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans', sans-serif; }
    body { background: var(--light); color: var(--dark); display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar { width: var(--sidebar-width); background: var(--white); position: fixed; height: 100%; border-right: 1px solid #e5e7eb; padding: 20px; z-index: 1000; display:flex; flex-direction:column; transition: transform 0.3s; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px; color: #6B7280; font-weight: 600; border-radius: 12px; cursor: pointer; margin-bottom: 5px; }
    .nav-item.active { background: #EEF2FF; color: var(--primary); }
    
    /* Main Content */
    .main { margin-left: var(--sidebar-width); flex: 1; padding: 20px; transition: 0.3s; }
    .section { display: none; } .section.active { display: block; }
    
    /* Cards */
    .draggable-item { background: var(--white); padding: 16px; border-radius: 16px; margin-bottom: 12px; border: 2px solid #f3f4f6; display: flex; align-items: center; gap: 12px; }
    .item-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; background: #eee; }
    .item-info { flex: 1; }
    .btn-icon { width: 36px; height: 36px; border-radius: 8px; border:none; cursor:pointer; font-size:18px; display:flex; justify-content:center; align-items:center; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal-overlay.open { display: flex; }
    .modal-box { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
    
    input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; background: #F9FAFB; }
    .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
    
    /* Veg Toggle */
    .toggle-wrap { display:flex; align-items:center; gap:10px; margin-bottom:12px; background:#f0fdf4; padding:10px; border-radius:10px; border:1px solid #bbf7d0; }
    .toggle-wrap label { color: #166534; font-weight: 700; font-size: 14px; }
  </style>
</head>

<body>
  <div class="sidebar">
    <div style="font-size:20px; font-weight:800; color:var(--primary); margin-bottom:30px; display:flex; align-items:center; gap:10px;">
      <i class='bx bxs-dashboard'></i> TABEY Admin
    </div>
    <div class="nav-item active" onclick="switchTab('orders')"><i class='bx bxs-shopping-bag'></i> Live Orders</div>
    <div class="nav-item" onclick="switchTab('menu')"><i class='bx bxs-food-menu'></i> Menu Items</div>
    <div class="nav-item" onclick="switchTab('stores')"><i class='bx bxs-store'></i> Stores</div>
  </div>

  <div class="main">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h1 class="page-title" style="font-size:24px; font-weight:800;">Dashboard</h1>
      <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="openAddModal()">+ Add New</button>
    </div>

    <div id="view-orders" class="section active">
      <div id="ordersList"></div>
    </div>

    <div id="view-menu" class="section">
      <div id="menuList"></div>
    </div>

    <div id="view-stores" class="section">
      <div id="storeList"></div>
    </div>
  </div>

  <div class="modal-overlay" id="menuModal">
    <div class="modal-box">
      <h2 style="margin-bottom:15px; font-weight:800;">Add Menu Item</h2>
      
      <label style="font-size:12px; font-weight:700; color:#666;">Name & Store</label>
      <input id="foodName" placeholder="Item Name (e.g. Chicken Biryani)">
      <select id="storeSelect"><option value="">Select Store</option></select>

      <label style="font-size:12px; font-weight:700; color:#666;">Category & Type</label>
      <select id="foodCat">
        <option value="All">Select Category</option>
        <option value="Pizza">Pizza</option>
        <option value="Burger">Burger</option>
        <option value="Asian">Asian/Chinese</option>
        <option value="Healthy">Healthy</option>
        <option value="Dessert">Dessert</option>
        <option value="Indian">Indian/Main Course</option>
      </select>

      <div class="toggle-wrap">
        <input type="checkbox" id="isVeg" style="width:20px; height:20px; margin:0;">
        <label for="isVeg">Is this Pure Veg?</label>
      </div>

      <label style="font-size:12px; font-weight:700; color:#666;">Image</label>
      <input type="file" id="foodImg">

      <div style="background:#F3F4F6; padding:15px; border-radius:12px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <small style="font-weight:800;">VARIANTS</small>
          <small onclick="addVariantRow()" style="color:var(--primary); font-weight:700; cursor:pointer;">+ Add Variant</small>
        </div>
        <div id="variantsWrap"></div>
      </div>

      <button class="btn-primary" onclick="saveItem()">Save Item</button>
      <button class="btn-primary" style="background:transparent; color:#666; margin-top:10px; border:1px solid #ddd;" onclick="closeModal('menuModal')">Cancel</button>
      <div id="status" style="text-align:center; font-size:13px; font-weight:700; margin-top:10px; color:var(--primary);"></div>
    </div>
  </div>

  <div class="modal-overlay" id="storeModal">
    <div class="modal-box">
      <h2 style="margin-bottom:15px; font-weight:800;">Add Store</h2>
      <input id="stName" placeholder="Store Name">
      <div style="display:flex; gap:10px;">
        <input id="stOpen" placeholder="Open (10:00 AM)">
        <input id="stClose" placeholder="Close (10:00 PM)">
      </div>
      <button class="btn-primary" onclick="saveStore()">Save Store</button>
      <button class="btn-primary" style="background:transparent; color:#666; margin-top:10px; border:1px solid #ddd;" onclick="closeModal('storeModal')">Cancel</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  
  const app = initializeApp({ apiKey: "AIzaSyCuVtOv09ixwnZszRKxjq3PQtiDn3kE5ng", projectId: "tabey-foods" });
  const db = getFirestore(app);

  // CLOUDINARY CONFIG
  const CLOUD_NAME = "dpcin9ipd"; 
  const UPLOAD_PRESET = "tabey_unsigned"; // MAKE SURE THIS EXISTS IN CLOUDINARY SETTINGS

  let currentTab='orders', editingMenuId=null, editingOldImg=null, editingStoreId=null;
  let menuItems=[], storeItems=[];

  window.switchTab = (tab) => {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(`view-${tab}`).classList.add('active');
    // Simplified nav highlighting
    if(tab==='orders') document.querySelectorAll('.nav-item')[0].classList.add('active');
    if(tab==='menu') document.querySelectorAll('.nav-item')[1].classList.add('active');
    if(tab==='stores') document.querySelectorAll('.nav-item')[2].classList.add('active');
    currentTab=tab;
  }

  // --- ORDERS ---
  onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snap) => {
    const list = document.getElementById("ordersList"); list.innerHTML = "";
    if(snap.empty) { list.innerHTML = "<div style='text-align:center; padding:40px; color:#999;'>No Orders Yet</div>"; return; }
    
    snap.forEach(doc => {
      const o = doc.data();
      list.innerHTML += `<div class="draggable-item" style="display:block;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:700;">
            <span>${o.customer?.name || 'Customer'}</span>
            <span style="color:${o.status==='Completed'?'green':'orange'}">${o.status}</span>
        </div>
        <div style="font-size:13px; color:#666;">${(o.items||[]).map(i=>`${i.qty}x ${i.name}`).join(', ')}</div>
        <div style="margin-top:10px; font-weight:800;">Total: ₹${o.bill?.total}</div>
        ${o.status==='Pending' ? `<div style="margin-top:10px; display:flex; gap:10px;">
            <button onclick="updateStatus('${doc.id}','Confirmed')" style="padding:5px 10px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer;">Accept</button>
            <button onclick="updateStatus('${doc.id}','Cancelled')" style="padding:5px 10px; background:#fee2e2; color:red; border:none; border-radius:5px; cursor:pointer;">Reject</button>
        </div>` : ''}
      </div>`;
    });
  });
  window.updateStatus = async (id, st) => updateDoc(doc(db,"orders",id), {status:st});

  // --- MENU ---
  onSnapshot(collection(db, "menu"), snap => {
    menuItems = []; snap.forEach(d => menuItems.push({id:d.id, ...d.data()}));
    const list = document.getElementById("menuList"); list.innerHTML = "";
    
    menuItems.forEach(item => {
      list.innerHTML += `<div class="draggable-item">
        <img src="${item.img || 'https://via.placeholder.com/60'}" class="item-img">
        <div class="item-info">
            <div style="font-weight:700;">${item.name}</div>
            <div style="font-size:12px; color:#666;">${item.storeName} • ${item.category}</div>
        </div>
        <button class="btn-icon" style="background:#fee2e2; color:red;" onclick="deleteMenu('${item.id}')"><i class='bx bxs-trash'></i></button>
      </div>`;
    });
  });

  // --- STORES ---
  onSnapshot(collection(db, "stores"), snap => {
    storeItems = []; snap.forEach(d => storeItems.push({id:d.id, ...d.data()}));
    const list = document.getElementById("storeList"); list.innerHTML = "";
    const select = document.getElementById("storeSelect");
    select.innerHTML = "<option value=''>Select Store</option>";

    storeItems.forEach(store => {
      // Populate Dropdown
      select.innerHTML += `<option value="${store.name}">${store.name}</option>`;
      
      // Render List
      list.innerHTML += `<div class="draggable-item">
        <div class="item-info">
            <div style="font-weight:700;">${store.name}</div>
            <div style="font-size:12px; color:${store.isOnline?'green':'red'};">${store.isOnline ? 'Online' : 'Offline'}</div>
        </div>
        <button class="btn-icon" style="background:#dcfce7; color:green;" onclick="toggleStore('${store.id}', ${store.isOnline})"><i class='bx bx-power-off'></i></button>
      </div>`;
    });
  });

  // --- ACTIONS ---
  window.openAddModal = () => {
    if(currentTab==='menu') {
        document.getElementById("foodName").value="";
        document.getElementById("variantsWrap").innerHTML="";
        addVariantRow("Full", 120);
        document.getElementById("menuModal").classList.add("open");
    } else {
        document.getElementById("storeModal").classList.add("open");
    }
  };
  window.closeModal = (id) => document.getElementById(id).classList.remove("open");
  
  window.addVariantRow = (l="", p="") => {
    document.getElementById("variantsWrap").insertAdjacentHTML('beforeend', 
    `<div style="display:flex;gap:8px;margin-bottom:8px;">
        <input class="vLabel" placeholder="Label" value="${l}" style="margin:0;flex:1;">
        <input class="vPrice" type="number" placeholder="Price" value="${p}" style="margin:0;width:80px;">
        <button style="background:#fee2e2; color:red; border:none; padding:0 10px; border-radius:8px;" onclick="this.parentElement.remove()">✕</button>
    </div>`);
  }

  // --- SAVE ITEM (ROBUST) ---
  window.saveItem = async () => {
    const name = document.getElementById("foodName").value;
    const store = document.getElementById("storeSelect").value;
    const cat = document.getElementById("foodCat").value;
    const isVeg = document.getElementById("isVeg").checked;
    const file = document.getElementById("foodImg").files[0];
    
    // Get Variants
    const vars = []; 
    document.querySelectorAll("#variantsWrap > div").forEach(r => { 
        vars.push({
            label: r.querySelector(".vLabel").value, 
            price: Number(r.querySelector(".vPrice").value)
        }); 
    });

    if(!name || !store || !vars.length) return alert("Please fill all fields");

    document.getElementById("status").innerText = "Uploading Image...";
    let img = "https://via.placeholder.com/300?text=No+Image"; // Default image

    // Image Upload Logic
    if(file) {
        try {
            const fd = new FormData();
            fd.append("file", file);
            fd.append("upload_preset", UPLOAD_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: fd });
            
            if(res.ok) {
                const data = await res.json();
                img = data.secure_url;
            } else {
                alert("Image upload failed. Saving with placeholder.");
            }
        } catch(e) {
            console.error(e);
            alert("Network error on image upload. Saving with placeholder.");
        }
    }

    document.getElementById("status").innerText = "Saving to Database...";
    
    // Save to Firestore
    await addDoc(collection(db, "menu"), {
        name, 
        storeName: store, 
        variants: vars, 
        img, 
        category: cat, 
        isVeg: isVeg,
        priority: menuItems.length + 1
    });

    closeModal("menuModal");
    document.getElementById("status").innerText = "";
    alert("Item Saved Successfully!");
  };

  window.saveStore = async () => {
    const name = document.getElementById("stName").value;
    if(!name) return;
    await addDoc(collection(db, "stores"), {
        name, 
        openTime: document.getElementById("stOpen").value, 
        closeTime: document.getElementById("stClose").value, 
        isOnline: true
    });
    closeModal("storeModal");
  }

  window.deleteMenu = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,"menu",id)); }
  window.toggleStore = async (id, s) => updateDoc(doc(db,"stores",id), {isOnline:!s});

</script>
</body>
</html>
