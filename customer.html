<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TABEY ‚Ä¢ Gourmet</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #FAFAFA; --card: #FFFFFF; --text: #18181B; --text-muted: #71717A;
    --border: #E4E4E7; --primary: #F43F5E; --accent: #10B981; --surface: #F4F4F5;
  }
  .dark {
    --bg: #09090B; --card: #18181B; --text: #FAFAFA; --text-muted: #A1A1AA;
    --border: #27272A; --surface: #27272A;
  }
  body {
    background-color: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif;
    -webkit-tap-highlight-color: transparent; transition: background-color 0.4s ease, color 0.4s ease;
  }
  
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  
  .glass {
    background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .dark .glass {
    background: rgba(24, 24, 27, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .toggle-checkbox { display: none; }
  .toggle-label {
    width: 44px; height: 24px; background: var(--surface); border-radius: 99px; position: relative; cursor: pointer; transition: 0.3s;
    border: 1px solid var(--border); display: block;
  }
  .toggle-label::after {
    content: ''; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; background: var(--text-muted); border-radius: 50%; transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
  }
  .toggle-checkbox:checked + .toggle-label { background: var(--surface); border-color: var(--accent); }
  .toggle-checkbox:checked + .toggle-label::after { transform: translateX(20px); background: var(--accent); }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes heartBeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  
  .animate-fade-up { animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  .animate-pulse-custom { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
  .animate-spin-slow { animation: spin 3s linear infinite; }

  .custom-radio input { display: none; }
  .custom-radio label {
    display: block; padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border);
    font-size: 11px; cursor: pointer; transition: all 0.2s; background: var(--bg); color: var(--text-muted);
  }
  .custom-radio input:checked + label {
    background: var(--text); color: var(--bg); border-color: var(--text);
  }

  .toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
    background: var(--card); color: var(--text); padding: 10px 20px; border-radius: 99px;
    font-weight: 500; font-size: 13px; opacity: 0; pointer-events: none; 
    transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1); z-index: 100;
    display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2);
    border: 1px solid var(--border);
  }
  .toast.show { transform: translateX(-50%) translateY(40px); opacity: 1; }
  
  .view-section { display: none; } 
  .view-section.active { display: block; }

  .skeleton { background: linear-gradient(90deg, var(--surface) 25%, var(--border) 50%, var(--surface) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }

  .favorite-btn.active { color: #F43F5E; }
  .favorite-btn.active iconify-icon { animation: heartBeat 0.3s ease; }

  .order-status-line { height: 3px; background: var(--border); border-radius: 99px; overflow: hidden; }
  .order-status-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #34d399); transition: width 0.5s ease; }
</style>
</head>
<body class="antialiased pb-28 selection:bg-rose-500 selection:text-white">

  <header class="glass fixed top-0 w-full z-50 px-6 py-4 flex justify-between items-center transition-all duration-300 shadow-sm">
    <div class="font-bold text-lg tracking-tight flex items-center gap-2 group cursor-pointer" onclick="switchTab('home')">
      <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-rose-500 to-orange-400 flex items-center justify-center text-white shadow-lg shadow-rose-500/20">
        <iconify-icon icon="solar:chef-hat-heart-linear" class="text-base"></iconify-icon>
      </div>
      <span class="text-[var(--text)]">TABEY</span>
    </div>
    <div class="flex gap-3 items-center">
      <button onclick="switchTab('favorites')" class="w-9 h-9 rounded-full border border-[var(--border)] flex items-center justify-center text-[var(--text)] hover:bg-[var(--surface)] transition-colors active:scale-90 relative">
        <iconify-icon icon="solar:heart-linear" class="text-lg"></iconify-icon>
        <span id="favCount" class="absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center scale-0 transition-transform">0</span>
      </button>
      <button id="themeToggle" class="w-9 h-9 rounded-full border border-[var(--border)] flex items-center justify-center text-[var(--text)] hover:bg-[var(--surface)] transition-colors active:scale-90">
        <iconify-icon icon="solar:moon-stars-linear" class="text-lg"></iconify-icon>
      </button>
      <div class="w-9 h-9 rounded-full overflow-hidden border border-[var(--border)] cursor-pointer active:scale-95 transition-transform" onclick="switchTab('profile')">
        <img id="userAvatar" src="https://ui-avatars.com/api/?name=Guest&background=random&color=fff" class="w-full h-full object-cover">
      </div>
    </div>
  </header>

  <div class="max-w-xl mx-auto px-5 pt-24">
    
    <!-- HOME VIEW -->
    <div id="view-home" class="view-section active">
      <div class="mb-6 animate-fade-up">
        <p class="text-sm text-[var(--text-muted)] mb-1" id="greetingText">Good morning!</p>
        <h1 class="text-3xl font-light text-[var(--text)]">Delicious <br><span class="font-semibold">Food for you</span></h1>
      </div>

      <!-- Delivery Address Bar -->
      <div onclick="openAddressModal()" class="mb-4 p-3 bg-[var(--surface)] rounded-2xl border border-[var(--border)] flex items-center gap-3 cursor-pointer hover:border-[var(--text-muted)] transition-all animate-fade-up">
        <div class="w-10 h-10 rounded-xl bg-[var(--primary)]/10 flex items-center justify-center text-[var(--primary)]">
          <iconify-icon icon="solar:map-point-bold" class="text-lg"></iconify-icon>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-[10px] text-[var(--text-muted)] uppercase tracking-wider font-semibold">Deliver to</p>
          <p class="text-sm font-medium text-[var(--text)] truncate" id="deliveryAddressText">Add your address</p>
        </div>
        <iconify-icon icon="solar:alt-arrow-right-linear" class="text-[var(--text-muted)]"></iconify-icon>
      </div>

      <div class="sticky top-[72px] z-40 bg-[var(--bg)]/95 backdrop-blur-sm pb-2 -mx-5 px-5 transition-colors duration-300">
        <div class="relative group mb-5">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <iconify-icon icon="solar:magnifer-linear" class="text-lg text-[var(--text-muted)] group-focus-within:text-[var(--primary)] transition-colors"></iconify-icon>
          </div>
          <input type="text" id="searchInput" placeholder="Search for sushi, burger..." 
            class="block w-full pl-11 pr-4 py-4 rounded-2xl bg-[var(--surface)] text-[var(--text)] placeholder-[var(--text-muted)] focus:outline-none focus:ring-1 focus:ring-[var(--border)] focus:bg-[var(--card)] transition-all duration-300 text-sm font-normal shadow-sm appearance-none">
        </div>
        <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2" id="categoryChips"></div>
      </div>

      <div class="flex justify-between items-center py-4 border-b border-[var(--border)] mb-6 animate-fade-up" style="animation-delay: 0.1s;">
        <div class="flex items-center gap-2">
          <iconify-icon icon="solar:leaf-linear" class="text-green-500 text-lg"></iconify-icon>
          <span class="text-sm font-medium text-[var(--text)]">Pure Veg Mode</span>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="vegToggle" class="toggle-checkbox">
          <label for="vegToggle" class="toggle-label"></label>
        </div>
      </div>

      <div id="storesList" class="flex flex-col gap-8 min-h-[400px]">
        <div class="space-y-4">
           <div class="h-6 w-32 skeleton rounded"></div>
           <div class="flex gap-4 overflow-hidden">
              <div class="min-w-[240px] h-64 skeleton rounded-3xl"></div>
              <div class="min-w-[240px] h-64 skeleton rounded-3xl"></div>
           </div>
        </div>
      </div>
    </div>

    <!-- FAVORITES VIEW -->
    <div id="view-favorites" class="view-section animate-fade-up">
      <div class="flex items-center gap-3 mb-6">
        <button onclick="switchTab('home')" class="w-10 h-10 rounded-xl bg-[var(--surface)] border border-[var(--border)] flex items-center justify-center">
          <iconify-icon icon="solar:arrow-left-linear" class="text-lg text-[var(--text)]"></iconify-icon>
        </button>
        <h2 class="text-2xl font-bold text-[var(--text)]">My Favorites</h2>
      </div>
      <div id="favoritesList" class="grid grid-cols-2 gap-4">
        <div class="col-span-2 p-12 text-center text-[var(--text-muted)]">
          <iconify-icon icon="solar:heart-broken-linear" class="text-4xl mb-2 block mx-auto opacity-50"></iconify-icon>
          <p class="text-sm">No favorites yet</p>
        </div>
      </div>
    </div>

    <!-- ORDERS VIEW -->
    <div id="view-orders" class="view-section animate-fade-up">
      <div class="flex items-center gap-3 mb-6">
        <button onclick="switchTab('home')" class="w-10 h-10 rounded-xl bg-[var(--surface)] border border-[var(--border)] flex items-center justify-center">
          <iconify-icon icon="solar:arrow-left-linear" class="text-lg text-[var(--text)]"></iconify-icon>
        </button>
        <h2 class="text-2xl font-bold text-[var(--text)]">My Orders</h2>
      </div>

      <div id="activeOrderSection" class="hidden mb-6">
        <h3 class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider mb-3">Active Order</h3>
        <div id="activeOrderCard" class="bg-[var(--card)] p-5 rounded-3xl border border-[var(--border)] shadow-sm"></div>
      </div>

      <h3 class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider mb-3">Order History</h3>
      <div id="orderHistory" class="space-y-4">
        <div class="p-6 skeleton rounded-2xl h-20"></div>
        <div class="p-6 skeleton rounded-2xl h-20"></div>
      </div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="view-section animate-fade-up">
      <div class="flex items-center gap-3 mb-6">
        <button onclick="switchTab('home')" class="w-10 h-10 rounded-xl bg-[var(--surface)] border border-[var(--border)] flex items-center justify-center">
          <iconify-icon icon="solar:arrow-left-linear" class="text-lg text-[var(--text)]"></iconify-icon>
        </button>
        <h2 class="text-2xl font-bold text-[var(--text)]">My Profile</h2>
      </div>
      
      <div class="bg-[var(--card)] p-5 rounded-3xl border border-[var(--border)] flex items-center gap-4 mb-6 shadow-sm">
        <img id="profileAvatar" src="" class="w-16 h-16 rounded-full bg-gray-200">
        <div class="flex-1">
          <h3 class="font-bold text-lg text-[var(--text)]" id="pName">...</h3>
          <p class="text-[var(--text-muted)] text-sm" id="pMobile">...</p>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 mb-6">
        <div class="bg-[var(--surface)] p-4 rounded-2xl border border-[var(--border)] text-center">
          <div class="text-2xl font-bold text-[var(--text)]" id="statOrders">0</div>
          <div class="text-[10px] text-[var(--text-muted)] uppercase tracking-wide">Orders</div>
        </div>
        <div class="bg-[var(--surface)] p-4 rounded-2xl border border-[var(--border)] text-center">
          <div class="text-2xl font-bold text-[var(--text)]" id="statFavs">0</div>
          <div class="text-[10px] text-[var(--text-muted)] uppercase tracking-wide">Favorites</div>
        </div>
        <div class="bg-[var(--surface)] p-4 rounded-2xl border border-[var(--border)] text-center">
          <div class="text-2xl font-bold text-[var(--text)]" id="statSpent">‚Çπ0</div>
          <div class="text-[10px] text-[var(--text-muted)] uppercase tracking-wide">Spent</div>
        </div>
      </div>

      <div class="space-y-2 mb-6">
        <button onclick="switchTab('orders')" class="w-full flex items-center gap-4 p-4 bg-[var(--card)] rounded-2xl border border-[var(--border)] hover:border-[var(--text-muted)] transition-all">
          <div class="w-10 h-10 rounded-xl bg-orange-50 text-orange-500 flex items-center justify-center"><iconify-icon icon="solar:bag-3-linear" class="text-lg"></iconify-icon></div>
          <span class="flex-1 text-left font-medium text-[var(--text)]">My Orders</span>
          <iconify-icon icon="solar:alt-arrow-right-linear" class="text-[var(--text-muted)]"></iconify-icon>
        </button>
        <button onclick="openAddressModal()" class="w-full flex items-center gap-4 p-4 bg-[var(--card)] rounded-2xl border border-[var(--border)] hover:border-[var(--text-muted)] transition-all">
          <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-500 flex items-center justify-center"><iconify-icon icon="solar:map-point-linear" class="text-lg"></iconify-icon></div>
          <span class="flex-1 text-left font-medium text-[var(--text)]">Saved Address</span>
          <iconify-icon icon="solar:alt-arrow-right-linear" class="text-[var(--text-muted)]"></iconify-icon>
        </button>
        <button onclick="window.location.href='support.html'" class="w-full flex items-center gap-4 p-4 bg-[var(--card)] rounded-2xl border border-[var(--border)] hover:border-[var(--text-muted)] transition-all">
          <div class="w-10 h-10 rounded-xl bg-green-50 text-green-500 flex items-center justify-center"><iconify-icon icon="solar:help-linear" class="text-lg"></iconify-icon></div>
          <span class="flex-1 text-left font-medium text-[var(--text)]">Help & Support</span>
          <iconify-icon icon="solar:alt-arrow-right-linear" class="text-[var(--text-muted)]"></iconify-icon>
        </button>
      </div>

      <button onclick="logout()" class="w-full py-4 rounded-2xl bg-red-50 text-red-500 font-bold border border-red-100 hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
        <iconify-icon icon="solar:logout-2-linear" class="text-lg"></iconify-icon>
        Logout
      </button>
    </div>

  </div>

  <!-- BOTTOM NAV -->
  <div class="fixed bottom-0 left-0 w-full z-50 glass border-t border-[var(--border)] pb-safe">
    <div class="max-w-xl mx-auto flex justify-around items-center px-2 py-3">
      <button onclick="switchTab('home')" class="flex flex-col items-center gap-1 p-2 text-[var(--primary)] transition-colors nav-btn" id="nav-home">
        <iconify-icon icon="solar:home-smile-bold" class="text-2xl"></iconify-icon>
        <span class="text-[10px] font-medium">Home</span>
      </button>
      <button onclick="switchTab('orders')" class="flex flex-col items-center gap-1 p-2 text-[var(--text-muted)] hover:text-[var(--text)] transition-colors nav-btn" id="nav-orders">
        <iconify-icon icon="solar:bag-3-linear" class="text-2xl"></iconify-icon>
        <span class="text-[10px] font-medium">Orders</span>
      </button>
      
      <div class="relative -top-8">
        <button id="cartFab" onclick="toggleCart()" class="w-16 h-16 bg-[var(--text)] text-[var(--bg)] rounded-full shadow-2xl flex items-center justify-center transform transition-all duration-300 hover:scale-105 active:scale-95 group">
          <iconify-icon icon="solar:bag-3-bold" class="text-2xl group-hover:animate-bounce"></iconify-icon>
          <span id="cartCount" class="absolute top-0 right-0 bg-rose-500 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center border-2 border-[var(--bg)] scale-0 transition-transform duration-300">0</span>
        </button>
      </div>

      <button onclick="switchTab('favorites')" class="flex flex-col items-center gap-1 p-2 text-[var(--text-muted)] hover:text-[var(--text)] transition-colors nav-btn" id="nav-favorites">
        <iconify-icon icon="solar:heart-linear" class="text-2xl"></iconify-icon>
        <span class="text-[10px] font-medium">Saved</span>
      </button>
      <button onclick="toggleAi()" class="flex flex-col items-center gap-1 p-2 text-[var(--text-muted)] hover:text-indigo-500 transition-colors">
        <iconify-icon icon="solar:magic-stick-3-linear" class="text-2xl"></iconify-icon>
        <span class="text-[10px] font-medium">AI Chef</span>
      </button>
    </div>
  </div>

  <!-- CART MODAL -->
  <div id="cartModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity duration-300 opacity-0" id="cartOverlay" onclick="toggleCart()"></div>
    <div class="absolute bottom-0 left-0 w-full bg-[var(--card)] rounded-t-[32px] p-0 flex flex-col shadow-2xl transition-transform duration-300 transform translate-y-full max-h-[90vh]" id="cartPanel">
      <div class="w-full flex justify-center pt-3 pb-1 cursor-pointer" onclick="toggleCart()">
        <div class="w-12 h-1 bg-[var(--border)] rounded-full"></div>
      </div>
      <div class="px-6 py-4 flex justify-between items-center border-b border-[var(--border)]">
        <h2 class="text-lg font-semibold tracking-tight text-[var(--text)]">Your Cart</h2>
        <span class="text-xs text-red-500 font-bold cursor-pointer hover:underline" onclick="clearCart()">Clear All</span>
      </div>
      <div id="cartItems" class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-4 min-h-[200px]"></div>
      
      <div class="p-6 bg-[var(--surface)] border-t border-[var(--border)] pb-8">
        <div class="space-y-2 mb-4">
          <div class="flex justify-between text-sm text-[var(--text-muted)]"><span>Subtotal</span><span id="subTotal">‚Çπ0</span></div>
          <div class="flex justify-between text-sm text-[var(--text-muted)]"><span>Delivery Fee</span><span class="text-orange-500">Calculated at checkout</span></div>
        </div>
        <div class="flex justify-between text-base font-semibold text-[var(--text)] mb-6 pt-3 border-t border-[var(--border)]"><span>Subtotal</span><span id="grandTotal">‚Çπ0</span></div>
        
        <button id="checkoutBtn" onclick="goToCheckout()" class="w-full bg-[var(--text)] text-[var(--bg)] py-4 rounded-2xl font-semibold text-sm flex justify-center items-center gap-3 shadow-xl active:scale-95 transition-all relative group overflow-hidden disabled:opacity-50 disabled:cursor-not-allowed">
          <span class="relative z-10">Proceed to Checkout</span>
          <iconify-icon icon="solar:arrow-right-linear" class="relative z-10 text-lg group-hover:translate-x-1 transition-transform"></iconify-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- AI MODAL -->
  <div id="aiModal" class="fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center pointer-events-none">
    <div class="absolute inset-0 bg-black/10 backdrop-blur-[2px] pointer-events-auto opacity-0 transition-opacity duration-300" id="aiOverlay" onclick="toggleAi()"></div>
    <div id="aiPanel" class="bg-[var(--card)] w-full sm:w-[400px] sm:rounded-3xl rounded-t-3xl p-6 pointer-events-auto transform translate-y-full transition-transform duration-300 border border-[var(--border)] shadow-2xl relative">
      <div class="absolute -top-12 left-1/2 -translate-x-1/2 w-10 h-10 bg-[var(--card)] rounded-full flex items-center justify-center border border-[var(--border)] text-indigo-500 shadow-lg">
        <iconify-icon icon="solar:stars-minimalistic-bold" class="text-xl animate-spin-slow"></iconify-icon>
      </div>
      <h3 class="text-center font-semibold text-lg mb-1 text-[var(--text)]">AI Food Assistant</h3>
      <p class="text-center text-xs text-[var(--text-muted)] mb-6">Tell me your mood or craving!</p>
      
      <div class="flex flex-wrap gap-2 mb-4 justify-center">
        <button onclick="askAI('I want something spicy')" class="px-3 py-1.5 bg-red-50 text-red-600 rounded-full text-xs font-medium border border-red-100 hover:bg-red-100 transition-colors">üå∂Ô∏è Spicy</button>
        <button onclick="askAI('I want something sweet')" class="px-3 py-1.5 bg-pink-50 text-pink-600 rounded-full text-xs font-medium border border-pink-100 hover:bg-pink-100 transition-colors">üç∞ Sweet</button>
        <button onclick="askAI('I want healthy food')" class="px-3 py-1.5 bg-green-50 text-green-600 rounded-full text-xs font-medium border border-green-100 hover:bg-green-100 transition-colors">ü•ó Healthy</button>
        <button onclick="askAI('I am very hungry')" class="px-3 py-1.5 bg-orange-50 text-orange-600 rounded-full text-xs font-medium border border-orange-100 hover:bg-orange-100 transition-colors">üçî Heavy</button>
      </div>

      <div class="relative">
        <input type="text" id="aiInput" placeholder="e.g., I'm feeling tired..." class="w-full bg-[var(--surface)] border border-[var(--border)] rounded-2xl pl-4 pr-12 py-3 text-sm focus:outline-none focus:border-indigo-500 transition-all text-[var(--text)]">
        <button onclick="askAI()" class="absolute right-2 top-2 p-1.5 bg-indigo-500 text-white rounded-xl flex items-center justify-center hover:bg-indigo-600 transition-colors"><iconify-icon icon="solar:plain-2-linear"></iconify-icon></button>
      </div>

      <div id="aiResponse" class="mt-4 hidden">
        <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
          <p class="text-sm text-indigo-800" id="aiResponseText"></p>
        </div>
        <div id="aiSuggestions" class="mt-3 space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- ADDRESS MODAL -->
  <div id="addressModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity duration-300 opacity-0" id="addressOverlay" onclick="closeAddressModal()"></div>
    <div class="absolute bottom-0 left-0 w-full bg-[var(--card)] rounded-t-[32px] p-6 shadow-2xl transition-transform duration-300 transform translate-y-full" id="addressPanel">
      <div class="w-full flex justify-center mb-4 cursor-pointer" onclick="closeAddressModal()">
        <div class="w-12 h-1 bg-[var(--border)] rounded-full"></div>
      </div>
      <h3 class="text-lg font-semibold text-[var(--text)] mb-4">Delivery Address</h3>
      
      <div class="space-y-3">
        <input type="text" id="addressLine1" placeholder="House/Flat No., Building Name" class="w-full bg-[var(--surface)] border border-[var(--border)] rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-[var(--primary)] transition-all text-[var(--text)]">
        <input type="text" id="addressLine2" placeholder="Street, Area, Landmark" class="w-full bg-[var(--surface)] border border-[var(--border)] rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-[var(--primary)] transition-all text-[var(--text)]">
        <input type="text" id="addressCity" placeholder="City, PIN Code" class="w-full bg-[var(--surface)] border border-[var(--border)] rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-[var(--primary)] transition-all text-[var(--text)]">
      </div>

      <button onclick="saveAddress()" class="w-full mt-6 bg-[var(--text)] text-[var(--bg)] py-4 rounded-2xl font-semibold text-sm">Save Address</button>
    </div>
  </div>

  <!-- ITEM DETAIL MODAL -->
  <div id="itemModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity duration-300 opacity-0" id="itemOverlay" onclick="closeItemModal()"></div>
    <div class="absolute bottom-0 left-0 w-full bg-[var(--card)] rounded-t-[32px] shadow-2xl transition-transform duration-300 transform translate-y-full max-h-[85vh] overflow-hidden" id="itemPanel">
      <div id="itemModalContent"></div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">
    <div class="w-5 h-5 rounded-full bg-green-500 flex items-center justify-center text-white text-xs"><iconify-icon icon="solar:check-read-linear"></iconify-icon></div>
    <span id="toastMsg" class="font-normal">Item added</span>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const app = initializeApp({ 
    apiKey: "AIzaSyCuVtOv09ixwnZszRKxjq3PQtiDn3kE5ng", 
    projectId: "tabey-foods" 
  });
  const db = getFirestore(app);

  // --- AUTH CHECK ---
  const userData = localStorage.getItem("tabey_user");
  const userRole = localStorage.getItem("tabey_role");
  
  let user = null;
  let isGuest = false;

  if(userRole === "guest") {
    isGuest = true;
    user = JSON.parse(localStorage.getItem("tabey_guest") || '{"name":"Guest User","mobile":"","address":"","isGuest":true}');
  } else if(userData) {
    user = JSON.parse(userData);
  } else {
    window.location.href = "customer-login.html";
  }

  const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=random&color=fff`;
  document.getElementById("userAvatar").src = avatarUrl;
  document.getElementById("profileAvatar").src = avatarUrl;
  document.getElementById("pName").innerText = user.name;
  document.getElementById("pMobile").innerText = user.mobile || "Guest User";

  // --- GREETING ---
  const setGreeting = () => {
    const hour = new Date().getHours();
    let greeting = "Good morning";
    if(hour >= 12 && hour < 17) greeting = "Good afternoon";
    else if(hour >= 17) greeting = "Good evening";
    const firstName = user.name.split(' ')[0];
    document.getElementById("greetingText").innerText = `${greeting}, ${firstName}! üëã`;
  };
  setGreeting();

  // --- STATE ---
  let STORES = [], MENU = [], CART = JSON.parse(localStorage.getItem('gourmet_cart')) || [];
  let FAVORITES = JSON.parse(localStorage.getItem('tabey_favorites')) || [];
  let FILTER = 'All', SEARCH = '', VEG_ONLY = false;
  let SAVED_ADDRESS = null;

  // Load saved address from user data or localStorage
  if(user.address) {
    try {
      SAVED_ADDRESS = typeof user.address === 'string' ? JSON.parse(user.address) : user.address;
    } catch(e) {
      SAVED_ADDRESS = { line1: user.address, line2: '', city: '' };
    }
  } else {
    SAVED_ADDRESS = JSON.parse(localStorage.getItem('tabey_address'));
  }

  // Cleanup bad data
  if(CART.some(i => !i.variant || i.variant === 'undefined')) {
    CART = CART.map(i => ({...i, variant: i.variant && i.variant !== 'undefined' ? i.variant : 'Regular'}));
    localStorage.setItem('gourmet_cart', JSON.stringify(CART));
  }

  // Display saved address
  if(SAVED_ADDRESS && SAVED_ADDRESS.line1) {
    document.getElementById('deliveryAddressText').innerText = SAVED_ADDRESS.line1;
  }

  // --- DB LISTENERS ---
  onSnapshot(collection(db, "stores"), (s) => { 
    STORES = []; 
    s.forEach(d => STORES.push({id:d.id, ...d.data()})); 
    renderStore(); 
  });
  
  onSnapshot(collection(db, "menu"), (s) => { 
    MENU = []; 
    s.forEach(d => MENU.push({id:d.id, ...d.data()})); 
    renderStore(); 
    renderFavorites();
  });

  const els = {
    stores: document.getElementById('storesList'),
    chips: document.getElementById('categoryChips'),
    search: document.getElementById('searchInput'),
    veg: document.getElementById('vegToggle'),
    cartCount: document.getElementById('cartCount'),
    cartModal: document.getElementById('cartModal'),
    cartOverlay: document.getElementById('cartOverlay'),
    cartPanel: document.getElementById('cartPanel'),
    cartItems: document.getElementById('cartItems'),
    themeBtn: document.getElementById('themeToggle'),
    toast: document.getElementById('toast'),
    checkoutBtn: document.getElementById('checkoutBtn'),
    favCount: document.getElementById('favCount')
  };

  // --- THEME LOGIC ---
  const initTheme = () => {
    if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
    updateThemeIcon();
  };
  const updateThemeIcon = () => {
    const isDark = document.documentElement.classList.contains('dark');
    els.themeBtn.innerHTML = isDark ? '<iconify-icon icon="solar:sun-2-linear" class="text-lg"></iconify-icon>' : '<iconify-icon icon="solar:moon-stars-linear" class="text-lg"></iconify-icon>';
  };
  els.themeBtn.onclick = () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    updateThemeIcon();
  };
  initTheme();

  // --- CATEGORIES ---
  const CATEGORIES = [ 
    { name: 'All', icon: 'solar:infinity-linear' }, 
    { name: 'Pizza', icon: 'solar:pizza-linear' }, 
    { name: 'Burger', icon: 'solar:hamburger-menu-linear' }, 
    { name: 'Asian', icon: 'solar:bowl-chopsticks-linear' }, 
    { name: 'Indian', icon: 'solar:bowl-hot-linear' },
    { name: 'Dessert', icon: 'solar:donut-linear' } 
  ];

  const renderChips = () => {
    els.chips.innerHTML = CATEGORIES.map(c => {
      const active = FILTER === c.name;
      return `<button onclick="setCat('${c.name}')" class="flex flex-col items-center gap-2 min-w-[64px] group flex-shrink-0"><div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl transition-all duration-300 ${active ? 'bg-[var(--text)] text-[var(--bg)] shadow-lg scale-105' : 'bg-[var(--surface)] text-[var(--text-muted)] border border-[var(--border)] group-hover:border-[var(--text)]'}"><iconify-icon icon="${c.icon}"></iconify-icon></div><span class="text-[10px] font-medium tracking-wide ${active ? 'text-[var(--text)]' : 'text-[var(--text-muted)]'}">${c.name}</span></button>`
    }).join('');
  };
  window.setCat = (c) => { FILTER = c; renderStore(); renderChips(); };

  // --- RENDER STORE ---
  const renderStore = () => {
    els.stores.innerHTML = '';
    const sortedStores = [...STORES].sort((a,b) => (b.isOnline?1:0) - (a.isOnline?1:0));

    if(sortedStores.length === 0) {
      els.stores.innerHTML = `<div class="p-12 text-center"><iconify-icon icon="solar:shop-minimalistic-linear" class="text-4xl text-[var(--text-muted)] mb-2"></iconify-icon><p class="text-[var(--text-muted)]">No stores available</p></div>`;
      return;
    }

    sortedStores.forEach((store) => {
      let items = MENU.filter(m => m.storeName === store.name);
      
      if (SEARCH) items = items.filter(i => i.name.toLowerCase().includes(SEARCH.toLowerCase()) || store.name.toLowerCase().includes(SEARCH.toLowerCase()));
      if (FILTER !== 'All') items = items.filter(i => i.category === FILTER);
      if (VEG_ONLY) items = items.filter(i => i.isVeg);

      let itemsHtml = "";
      if (items.length === 0) {
        itemsHtml = `<div class="p-6 text-sm text-[var(--text-muted)] italic w-full text-center bg-[var(--surface)] rounded-2xl border border-[var(--border)]">No items match your filter.</div>`;
      } else {
        itemsHtml = items.map(item => {
          const variants = item.variants || [{label: 'Regular', price: item.price || 0}];
          const uid = Math.random().toString(36).substr(2, 9);
          const imgUrl = item.img || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300';
          const isFav = FAVORITES.includes(item.id);
          
          const variantHtml = variants.length > 1 ? `
            <div class="flex gap-2 mt-3 overflow-x-auto no-scrollbar pb-1" id="var-group-${uid}">
              ${variants.map((v, idx) => `<div class="custom-radio"><input type="radio" id="radio-${uid}-${idx}" name="var-${uid}" value="${v.label}|${v.price}" ${idx===0?'checked':''} onchange="document.getElementById('price-${uid}').innerText='${v.price}'"><label for="radio-${uid}-${idx}">${v.label}</label></div>`).join('')}
            </div>` : `<div class="h-2 mt-3"></div>`;

          return `
            <div class="min-w-[260px] max-w-[260px] bg-[var(--card)] p-4 rounded-[32px] border border-[var(--border)] shadow-sm flex flex-col snap-start relative group hover:border-[var(--text-muted)] transition-colors duration-300">
              <button onclick="event.stopPropagation(); toggleFavorite('${item.id}')" class="favorite-btn absolute top-6 right-6 z-10 w-8 h-8 rounded-full bg-white/90 backdrop-blur flex items-center justify-center shadow-md ${isFav ? 'active' : 'text-gray-400'}">
                <iconify-icon icon="${isFav ? 'solar:heart-bold' : 'solar:heart-linear'}" class="text-lg"></iconify-icon>
              </button>
              ${item.isVeg ? '<div class="absolute top-6 left-6 z-10 w-6 h-6 rounded-md bg-green-500 flex items-center justify-center"><iconify-icon icon="solar:leaf-bold" class="text-white text-xs"></iconify-icon></div>' : ''}
              <div onclick="openItemModal('${item.id}')" class="h-40 w-full rounded-[24px] overflow-hidden mb-4 relative bg-gray-100 cursor-pointer">
                <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy" onerror="this.src='https://via.placeholder.com/300x200?text=Food'">
              </div>
              <div class="flex-1 flex flex-col">
                <h4 class="font-semibold text-[var(--text)] text-base leading-tight line-clamp-2">${item.name}</h4>
                ${variantHtml}
                <div class="mt-auto pt-4 flex justify-between items-end">
                  <div>
                    <span class="text-[10px] text-[var(--text-muted)] uppercase tracking-wider font-semibold">Price</span>
                    <div class="font-bold text-xl text-[var(--text)] tracking-tight">‚Çπ<span id="price-${uid}">${variants[0].price}</span></div>
                  </div>
                  <button onclick="addToCart('${item.id}', '${item.name.replace(/'/g, "\\'")}', '${store.name.replace(/'/g, "\\'")}', '${uid}', ${variants.length > 1})" 
                    class="w-10 h-10 rounded-full bg-[var(--text)] text-[var(--bg)] flex items-center justify-center text-lg shadow-lg active:scale-90 transition-all cursor-pointer"><iconify-icon icon="solar:add-circle-linear"></iconify-icon>
                  </button>
                </div>
              </div>
            </div>`;
        }).join('');
      }

      const section = document.createElement('div');
      section.className = `store-section animate-fade-up ${!store.isOnline ? 'opacity-60 grayscale pointer-events-none' : ''}`;
      
      section.innerHTML = `
        <div class="flex justify-between items-center mb-5 px-1">
          <div class="flex items-center gap-3">
             <div class="w-10 h-10 rounded-xl bg-[var(--surface)] flex items-center justify-center text-xl text-[var(--text)] border border-[var(--border)]"><iconify-icon icon="solar:shop-2-linear"></iconify-icon></div>
             <div><h3 class="font-bold text-lg text-[var(--text)] tracking-tight">${store.name}</h3><div class="flex items-center gap-1 text-xs text-[var(--text-muted)]"><iconify-icon icon="solar:clock-circle-linear"></iconify-icon> 25-30 min</div></div>
          </div>
          <span class="px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wide border ${store.isOnline ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-rose-50 text-rose-600 border-rose-100'}">${store.isOnline ? 'Open' : 'Closed'}</span>
        </div>
        <div class="flex gap-4 overflow-x-auto no-scrollbar pb-6 snap-x px-1">${itemsHtml}</div>`;
      els.stores.appendChild(section);
    });
  };

  // --- FAVORITES ---
  window.toggleFavorite = (id) => {
    const idx = FAVORITES.indexOf(id);
    if(idx > -1) {
      FAVORITES.splice(idx, 1);
      showToast('Removed from favorites');
    } else {
      FAVORITES.push(id);
      showToast('Added to favorites ‚ù§Ô∏è');
    }
    localStorage.setItem('tabey_favorites', JSON.stringify(FAVORITES));
    updateFavCount();
    renderStore();
    renderFavorites();
  };

  const updateFavCount = () => {
    if(FAVORITES.length > 0) {
      els.favCount.innerText = FAVORITES.length;
      els.favCount.classList.remove('scale-0');
    } else {
      els.favCount.classList.add('scale-0');
    }
    document.getElementById('statFavs').innerText = FAVORITES.length;
  };

  const renderFavorites = () => {
    const container = document.getElementById('favoritesList');
    const favItems = MENU.filter(m => FAVORITES.includes(m.id));
    
    if(favItems.length === 0) {
      container.innerHTML = `<div class="col-span-2 p-12 text-center text-[var(--text-muted)]"><iconify-icon icon="solar:heart-broken-linear" class="text-4xl mb-2 block mx-auto opacity-50"></iconify-icon><p class="text-sm">No favorites yet</p></div>`;
      return;
    }

    container.innerHTML = favItems.map(item => {
      const price = item.variants?.[0]?.price || item.price || 0;
      return `
        <div class="bg-[var(--card)] p-4 rounded-2xl border border-[var(--border)] relative cursor-pointer" onclick="openItemModal('${item.id}')">
          <button onclick="event.stopPropagation(); toggleFavorite('${item.id}')" class="absolute top-3 right-3 text-rose-500 z-10"><iconify-icon icon="solar:heart-bold"></iconify-icon></button>
          <img src="${item.img || 'https://via.placeholder.com/100'}" class="w-full h-24 object-cover rounded-xl mb-3">
          <h4 class="font-medium text-sm text-[var(--text)] line-clamp-1">${item.name}</h4>
          <p class="text-[var(--text-muted)] text-xs">${item.storeName}</p>
          <div class="flex justify-between items-center mt-2">
            <span class="font-bold text-[var(--text)]">‚Çπ${price}</span>
          </div>
        </div>`;
    }).join('');
  };

  // --- CART ---
  window.addToCart = (id, name, store, uid, hasVariants) => {
    let variant = 'Regular', price = 0;
    if(hasVariants) {
      const radios = document.getElementsByName(`var-${uid}`);
      for(let r of radios) { if(r.checked) { [variant, price] = r.value.split('|'); break; } }
    } else { 
      price = document.getElementById(`price-${uid}`).innerText; 
    }

    const key = `${id}-${variant}`;
    const exist = CART.find(x => x.key === key);
    if(exist) exist.qty++;
    else CART.push({ key, id, name, store, storeName: store, variant, price: parseInt(price), qty: 1 });
    updateCart();
    showToast(`Added ${name}`);
  };

  window.updateQty = (key, delta) => {
    const idx = CART.findIndex(x => x.key === key);
    if(idx > -1) { 
      CART[idx].qty += delta; 
      if(CART[idx].qty <= 0) CART.splice(idx, 1); 
      updateCart(); 
    }
  };

  window.clearCart = () => { 
    if(confirm('Clear all items from cart?')) {
      CART = []; 
      localStorage.removeItem('gourmet_cart');
      updateCart(); 
      showToast('Cart cleared');
    }
  };

  const updateCart = () => {
    localStorage.setItem('gourmet_cart', JSON.stringify(CART));
    const count = CART.reduce((a,b) => a + b.qty, 0);
    
    if(count > 0) { 
      els.cartCount.innerText = count; 
      els.cartCount.classList.remove('scale-0'); 
    } else { 
      els.cartCount.classList.add('scale-0'); 
    }

    if(CART.length === 0) {
      els.cartItems.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-[var(--text-muted)]"><iconify-icon icon="solar:bag-3-linear" class="text-4xl mb-2 opacity-50"></iconify-icon><span class="text-sm">Your cart is empty</span></div>`;
      document.getElementById('subTotal').innerText = '‚Çπ0';
      document.getElementById('grandTotal').innerText = '‚Çπ0';
      els.checkoutBtn.disabled = true;
    } else {
      els.cartItems.innerHTML = CART.map(item => `
        <div class="flex justify-between items-center bg-[var(--surface)] p-3 rounded-2xl border border-[var(--border)] animate-fade-up">
          <div class="flex items-center gap-3 flex-1 min-w-0">
             <div class="w-10 h-10 rounded-xl bg-[var(--card)] border border-[var(--border)] flex items-center justify-center text-[var(--text-muted)] flex-shrink-0"><iconify-icon icon="solar:dish-2-linear"></iconify-icon></div>
             <div class="flex-1 min-w-0"><div class="font-semibold text-sm text-[var(--text)] line-clamp-1">${item.name}</div><div class="text-[10px] text-[var(--text-muted)] font-medium">${item.variant} ‚Ä¢ ‚Çπ${item.price}</div></div>
          </div>
          <div class="flex items-center gap-3 bg-[var(--card)] px-2 py-1.5 rounded-xl border border-[var(--border)] shadow-sm ml-2">
            <button onclick="updateQty('${item.key}', -1)" class="w-5 h-5 flex items-center justify-center hover:text-red-500 transition-colors"><iconify-icon icon="solar:minus-circle-linear"></iconify-icon></button>
            <span class="text-xs font-bold w-3 text-center">${item.qty}</span>
            <button onclick="updateQty('${item.key}', 1)" class="w-5 h-5 flex items-center justify-center hover:text-green-500 transition-colors"><iconify-icon icon="solar:add-circle-linear"></iconify-icon></button>
          </div>
        </div>`).join('');
      
      const sub = CART.reduce((a,b) => a + (b.price * b.qty), 0);
      
      document.getElementById('subTotal').innerText = '‚Çπ' + sub;
      document.getElementById('grandTotal').innerText = '‚Çπ' + sub;
      
      els.checkoutBtn.disabled = false;
    }
  };

  // --- CHECKOUT REDIRECT ---
  window.goToCheckout = () => {
    if(CART.length === 0) {
      showToast('Cart is empty');
      return;
    }
    
    if(isGuest) {
      if(confirm('Please login to place order. Continue to login page?')) {
        window.location.href = 'customer-login.html';
      }
      return;
    }
    
    toggleCart();
    setTimeout(() => {
      window.location.href = 'checkout.html';
    }, 300);
  };

  // --- MODALS ---
  window.toggleCart = () => {
    const modal = els.cartModal, panel = els.cartPanel, overlay = els.cartOverlay;
    if(modal.classList.contains('hidden')) { 
      modal.classList.remove('hidden'); 
      setTimeout(() => { overlay.classList.remove('opacity-0'); panel.classList.remove('translate-y-full'); }, 10); 
    } else { 
      overlay.classList.add('opacity-0'); 
      panel.classList.add('translate-y-full'); 
      setTimeout(() => modal.classList.add('hidden'), 300); 
    }
  };

  window.toggleAi = () => {
    const m = document.getElementById('aiModal'), o = document.getElementById('aiOverlay'), p = document.getElementById('aiPanel');
    if(m.classList.contains('hidden')) { 
      m.classList.remove('hidden'); 
      setTimeout(() => { o.classList.remove('opacity-0'); p.classList.remove('translate-y-full'); }, 10); 
    } else { 
      o.classList.add('opacity-0'); 
      p.classList.add('translate-y-full'); 
      setTimeout(() => m.classList.add('hidden'), 300); 
    }
  };

  window.openAddressModal = () => {
    const m = document.getElementById('addressModal'), o = document.getElementById('addressOverlay'), p = document.getElementById('addressPanel');
    if(SAVED_ADDRESS) {
      document.getElementById('addressLine1').value = SAVED_ADDRESS.line1 || '';
      document.getElementById('addressLine2').value = SAVED_ADDRESS.line2 || '';
      document.getElementById('addressCity').value = SAVED_ADDRESS.city || '';
    }
    m.classList.remove('hidden');
    setTimeout(() => { o.classList.remove('opacity-0'); p.classList.remove('translate-y-full'); }, 10);
  };

  window.closeAddressModal = () => {
    const m = document.getElementById('addressModal'), o = document.getElementById('addressOverlay'), p = document.getElementById('addressPanel');
    o.classList.add('opacity-0'); p.classList.add('translate-y-full');
    setTimeout(() => m.classList.add('hidden'), 300);
  };

  window.saveAddress = () => {
    const line1 = document.getElementById('addressLine1').value.trim();
    const line2 = document.getElementById('addressLine2').value.trim();
    const city = document.getElementById('addressCity').value.trim();
    
    if(!line1) { showToast('Please enter address'); return; }
    
    SAVED_ADDRESS = { line1, line2, city };
    localStorage.setItem('tabey_address', JSON.stringify(SAVED_ADDRESS));
    document.getElementById('deliveryAddressText').innerText = line1;
    
    // Update user data in localStorage
    if(!isGuest) {
      user.address = JSON.stringify(SAVED_ADDRESS);
      localStorage.setItem('tabey_user', JSON.stringify(user));
    }
    
    closeAddressModal();
    showToast('Address saved!');
  };

  window.openItemModal = (itemId) => {
    const item = MENU.find(m => m.id === itemId);
    if(!item) return;

    const m = document.getElementById('itemModal'), o = document.getElementById('itemOverlay'), p = document.getElementById('itemPanel');
    const variants = item.variants || [{label: 'Regular', price: item.price || 0}];
    const isFav = FAVORITES.includes(item.id);

    document.getElementById('itemModalContent').innerHTML = `
      <div class="relative">
        <img src="${item.img || 'https://via.placeholder.com/400'}" class="w-full h-64 object-cover">
        <button onclick="closeItemModal()" class="absolute top-4 left-4 w-10 h-10 rounded-full bg-black/50 backdrop-blur text-white flex items-center justify-center">
          <iconify-icon icon="solar:arrow-left-linear" class="text-lg"></iconify-icon>
        </button>
        <button onclick="toggleFavorite('${item.id}'); renderItemModalFav('${item.id}')" class="favorite-btn absolute top-4 right-4 w-10 h-10 rounded-full bg-white shadow-lg flex items-center justify-center ${isFav ? 'active' : 'text-gray-400'}" id="itemModalFavBtn">
          <iconify-icon icon="${isFav ? 'solar:heart-bold' : 'solar:heart-linear'}" class="text-lg"></iconify-icon>
        </button>
        ${item.isVeg ? '<div class="absolute bottom-4 left-4 px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full flex items-center gap-1"><iconify-icon icon="solar:leaf-bold"></iconify-icon> Pure Veg</div>' : ''}
      </div>
      <div class="p-6">
        <h3 class="text-xl font-bold text-[var(--text)] mb-2">${item.name}</h3>
        <p class="text-sm text-[var(--text-muted)] mb-4">${item.storeName}</p>
        
        ${variants.length > 1 ? `
          <div class="mb-4">
            <p class="text-xs font-bold text-[var(--text-muted)] uppercase mb-2">Select Size</p>
            <div class="flex gap-2 flex-wrap">
              ${variants.map((v, idx) => `<div class="custom-radio"><input type="radio" id="modal-radio-${idx}" name="modal-var" value="${v.label}|${v.price}" ${idx===0?'checked':''} onchange="document.getElementById('modal-price').innerText='${v.price}'"><label for="modal-radio-${idx}">${v.label} - ‚Çπ${v.price}</label></div>`).join('')}
            </div>
          </div>` : ''}
        
        <div class="flex items-center justify-between pt-4 border-t border-[var(--border)]">
          <div>
            <span class="text-xs text-[var(--text-muted)]">Price</span>
            <div class="text-2xl font-bold text-[var(--text)]">‚Çπ<span id="modal-price">${variants[0].price}</span></div>
          </div>
          <button onclick="addToCartFromModal('${item.id}', '${item.name.replace(/'/g, "\\'")}', '${item.storeName.replace(/'/g, "\\'")}', ${variants.length > 1})" class="px-6 py-3 bg-[var(--text)] text-[var(--bg)] rounded-2xl font-semibold text-sm flex items-center gap-2 active:scale-95 transition-transform">
            <iconify-icon icon="solar:bag-3-bold"></iconify-icon> Add to Cart
          </button>
        </div>
      </div>`;

    m.classList.remove('hidden');
    setTimeout(() => { o.classList.remove('opacity-0'); p.classList.remove('translate-y-full'); }, 10);
  };

  window.closeItemModal = () => {
    const m = document.getElementById('itemModal'), o = document.getElementById('itemOverlay'), p = document.getElementById('itemPanel');
    o.classList.add('opacity-0'); p.classList.add('translate-y-full');
    setTimeout(() => m.classList.add('hidden'), 300);
  };

  window.renderItemModalFav = (id) => {
    const btn = document.getElementById('itemModalFavBtn');
    const isFav = FAVORITES.includes(id);
    btn.className = `favorite-btn absolute top-4 right-4 w-10 h-10 rounded-full bg-white shadow-lg flex items-center justify-center ${isFav ? 'active' : 'text-gray-400'}`;
    btn.innerHTML = `<iconify-icon icon="${isFav ? 'solar:heart-bold' : 'solar:heart-linear'}" class="text-lg"></iconify-icon>`;
  };

  window.addToCartFromModal = (id, name, store, hasVariants) => {
    let variant = 'Regular', price = document.getElementById('modal-price').innerText;
    if(hasVariants) {
      const radios = document.getElementsByName('modal-var');
      for(let r of radios) { if(r.checked) { [variant, price] = r.value.split('|'); break; } }
    }

    const key = `${id}-${variant}`;
    const exist = CART.find(x => x.key === key);
    if(exist) exist.qty++;
    else CART.push({ key, id, name, store, storeName: store, variant, price: parseInt(price), qty: 1 });
    updateCart();
    closeItemModal();
    showToast(`Added ${name}`);
  };

  // --- AI CHEF ---
  window.askAI = (mood) => {
    const input = document.getElementById('aiInput');
    const query = mood || input.value.trim();
    if(!query) return;

    const responseDiv = document.getElementById('aiResponse');
    const responseText = document.getElementById('aiResponseText');
    const suggestions = document.getElementById('aiSuggestions');

    let response = '';
    let suggestedItems = [];
    const queryLower = query.toLowerCase();

    if(queryLower.includes('spicy') || queryLower.includes('hot')) {
      response = "üå∂Ô∏è Craving something fiery! Here are some spicy picks:";
      suggestedItems = MENU.filter(m => m.name.toLowerCase().includes('spicy') || m.category === 'Indian').slice(0, 3);
    } else if(queryLower.includes('sweet') || queryLower.includes('dessert')) {
      response = "üç∞ Something sweet coming right up!";
      suggestedItems = MENU.filter(m => m.category === 'Dessert').slice(0, 3);
    } else if(queryLower.includes('healthy') || queryLower.includes('light')) {
      response = "ü•ó Healthy choices for the win!";
      suggestedItems = MENU.filter(m => m.isVeg).slice(0, 3);
    } else if(queryLower.includes('hungry') || queryLower.includes('heavy')) {
      response = "üçî Big appetite? Let's fill you up!";
      suggestedItems = MENU.filter(m => m.category === 'Burger' || m.category === 'Pizza').slice(0, 3);
    } else {
      response = "ü§ñ Based on your mood, here are my picks:";
      suggestedItems = MENU.sort(() => Math.random() - 0.5).slice(0, 3);
    }

    responseText.innerText = response;
    
    if(suggestedItems.length > 0) {
      suggestions.innerHTML = suggestedItems.map(item => `
        <div onclick="toggleAi(); setTimeout(() => openItemModal('${item.id}'), 300)" class="flex items-center gap-3 p-3 bg-[var(--surface)] rounded-xl cursor-pointer hover:bg-[var(--border)] transition-colors">
          <img src="${item.img || 'https://via.placeholder.com/50'}" class="w-12 h-12 rounded-lg object-cover">
          <div class="flex-1">
            <p class="text-sm font-medium text-[var(--text)]">${item.name}</p>
            <p class="text-xs text-[var(--text-muted)]">${item.storeName}</p>
          </div>
          <span class="font-bold text-[var(--text)]">‚Çπ${item.variants?.[0]?.price || item.price || 0}</span>
        </div>`).join('');
    } else {
      suggestions.innerHTML = '<p class="text-sm text-[var(--text-muted)] text-center">No matching items found.</p>';
    }

    responseDiv.classList.remove('hidden');
    input.value = '';
  };

  // --- NAV ---
  window.switchTab = (t) => {
    document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
    document.getElementById(`view-${t}`).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(n => { 
      n.classList.remove('text-[var(--primary)]'); 
      n.classList.add('text-[var(--text-muted)]'); 
    });
    
    const activeNav = document.getElementById(`nav-${t}`);
    if(activeNav) {
      activeNav.classList.remove('text-[var(--text-muted)]');
      activeNav.classList.add('text-[var(--primary)]');
    }

    if(t === 'orders') loadHistory();
    if(t === 'profile') loadProfile();
    if(t === 'favorites') renderFavorites();
  };

  // --- ORDER HISTORY ---
  const loadHistory = async () => {
    if(isGuest) {
      const box = document.getElementById("orderHistory");
      box.innerHTML = `<div class="p-8 text-center text-[var(--text-muted)]"><iconify-icon icon="solar:lock-linear" class="text-4xl mb-2 block mx-auto opacity-50"></iconify-icon><p class="text-sm">Please login to view orders</p><button onclick="window.location.href='customer-login.html'" class="mt-4 px-6 py-2 bg-[var(--primary)] text-white rounded-xl font-medium">Login Now</button></div>`;
      document.getElementById('activeOrderSection').classList.add('hidden');
      return;
    }

    try {
      const q = query(
        collection(db, "orders"), 
        where("customer.mobile", "==", user.mobile), 
        orderBy("timestamp", "desc"), 
        limit(20)
      );
      
      const snap = await getDocs(q);
      const box = document.getElementById("orderHistory");
      
      let totalSpent = 0;
      let orderCount = 0;
      let hasActive = false;

      if(snap.empty) { 
        box.innerHTML = `<div class="p-8 text-center text-[var(--text-muted)]"><iconify-icon icon="solar:bag-3-linear" class="text-4xl mb-2 block mx-auto opacity-50"></iconify-icon><p class="text-sm">No orders yet</p><p class="text-xs mt-2">Start ordering delicious food!</p></div>`; 
        document.getElementById('activeOrderSection').classList.add('hidden');
        return; 
      }
      
      box.innerHTML = "";
      
      snap.forEach((d) => {
        const o = d.data();
        const billTotal = o.bill?.total || o.total || 0;
        totalSpent += billTotal;
        orderCount++;

        // Check for active order (Pending, Preparing, Out for Delivery)
        const activeStatuses = ['Pending', 'Preparing', 'Out for Delivery'];
        if(activeStatuses.includes(o.status) && !hasActive) {
          hasActive = true;
          document.getElementById('activeOrderSection').classList.remove('hidden');
          
          const statusProgress = {
            'Pending': 25,
            'Preparing': 50,
            'Out for Delivery': 75,
            'Completed': 100
          };
          const progress = statusProgress[o.status] || 25;
          
          document.getElementById('activeOrderCard').innerHTML = `
            <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 rounded-2xl bg-orange-50 flex items-center justify-center text-orange-500">
                <iconify-icon icon="solar:delivery-linear" class="text-2xl animate-pulse-custom"></iconify-icon>
              </div>
              <div class="flex-1">
                <h4 class="font-bold text-[var(--text)]">Order #${d.id.slice(-6).toUpperCase()}</h4>
                <p class="text-xs text-[var(--text-muted)]">${o.items?.length || 0} items ‚Ä¢ ‚Çπ${billTotal}</p>
              </div>
              <span class="text-xs font-bold text-orange-500 bg-orange-50 px-3 py-1 rounded-full">${o.status}</span>
            </div>
            <div class="order-status-line mb-2">
              <div class="order-status-fill" style="width: ${progress}%"></div>
            </div>
            <div class="flex justify-between text-[10px] text-[var(--text-muted)] uppercase tracking-wider">
              <span>Confirmed</span><span>Preparing</span><span>On the way</span><span>Delivered</span>
            </div>`;
        }

        // Format timestamp
        let date = 'N/A';
        if(o.timestamp) {
          if(typeof o.timestamp === 'number') {
            date = new Date(o.timestamp).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
          } else if(o.timestamp.seconds) {
            date = new Date(o.timestamp.seconds * 1000).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
          }
        }

        // Get item names
        const itemNames = o.items?.map(i => i.name || 'Item').join(', ') || 'Items not available';

        box.innerHTML += `
          <div class="p-4 bg-[var(--card)] rounded-2xl border border-[var(--border)] shadow-sm">
            <div class="flex justify-between items-start mb-2">
              <div>
                <span class="text-xs text-[var(--text-muted)]">${date}</span>
                <h4 class="font-bold text-[var(--text)]">‚Çπ${billTotal}</h4>
              </div>
              <span class="text-xs font-bold px-2 py-1 rounded-full ${o.status==='Completed' ? 'bg-emerald-50 text-emerald-600' : o.status==='Cancelled' ? 'bg-red-50 text-red-600' : 'bg-orange-50 text-orange-600'}">${o.status}</span>
            </div>
            <p class="text-xs text-[var(--text-muted)] line-clamp-1">${itemNames}</p>
            ${o.storeName ? `<p class="text-xs text-[var(--text-muted)] mt-1"><iconify-icon icon="solar:shop-2-linear" class="text-xs"></iconify-icon> ${o.storeName}</p>` : ''}
          </div>`;
      });

      if(!hasActive) {
        document.getElementById('activeOrderSection').classList.add('hidden');
      }
      
      document.getElementById('statOrders').innerText = orderCount;
      document.getElementById('statSpent').innerText = '‚Çπ' + totalSpent;
      
    } catch(e) {
      console.error('Error loading history:', e);
      const box = document.getElementById("orderHistory");
      box.innerHTML = `<div class="p-8 text-center text-red-500"><iconify-icon icon="solar:danger-triangle-linear" class="text-4xl mb-2 block mx-auto"></iconify-icon><p class="text-sm">Error loading orders</p><p class="text-xs mt-1">${e.message}</p></div>`;
      document.getElementById('activeOrderSection').classList.add('hidden');
    }
  };

  // --- LOAD PROFILE STATS ---
  const loadProfile = async () => {
    if(isGuest) {
      document.getElementById('statOrders').innerText = '0';
      document.getElementById('statSpent').innerText = '‚Çπ0';
      return;
    }

    try {
      const q = query(
        collection(db, "orders"), 
        where("customer.mobile", "==", user.mobile)
      );
      const snap = await getDocs(q);
      
      let total = 0;
      snap.forEach(d => {
        const o = d.data();
        total += o.bill?.total || o.total || 0;
      });
      
      document.getElementById('statOrders').innerText = snap.size;
      document.getElementById('statSpent').innerText = '‚Çπ' + total;
    } catch(e) {
      console.error('Error loading profile stats:', e);
    }
  };

  // --- LOGOUT ---
  window.logout = () => { 
    if(confirm('Are you sure you want to logout?')) {
      localStorage.removeItem("tabey_user");
      localStorage.removeItem("tabey_guest");
      localStorage.removeItem("tabey_role");
      localStorage.removeItem("gourmet_cart");
      localStorage.removeItem("tabey_favorites");
      localStorage.removeItem("tabey_address");
      window.location.href = "customer-login.html"; 
    }
  };

  // --- TOAST ---
  const showToast = (msg) => {
    const t = els.toast;
    t.querySelector('#toastMsg').innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  };

  // --- EVENT LISTENERS ---
  els.search.addEventListener('input', (e) => { SEARCH = e.target.value; renderStore(); });
  els.veg.addEventListener('change', (e) => { VEG_ONLY = e.target.checked; renderStore(); });

  // --- INIT ---
  renderChips(); 
  updateCart();
  updateFavCount();
  loadProfile();
</script>
</body>
</html>
