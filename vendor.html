<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TABEY‚Ä¢ Partner Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<style>
  :root { --bg: #F3F4F6; --white: #fff; --text: #1F2937; --primary: #3B82F6; --green: #10B981; --red: #EF4444; }
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans',sans-serif; -webkit-tap-highlight-color:transparent; }
  body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

  /* HEADER */
  .header { background: var(--white); padding: 15px 20px; position: sticky; top: 0; z-index: 90; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
  .shop-info h2 { font-size: 18px; font-weight: 800; color: var(--text); margin: 0; }
  .shop-info span { font-size: 11px; color: #6B7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  
  .controls { display: flex; gap: 8px; }
  .status-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 50px; height: 50px; border-radius: 12px; background: #F3F4F6; border: 1px solid #E5E7EB; cursor: pointer; transition: 0.2s; }
  .status-btn i { font-size: 20px; margin-bottom: 2px; color: #9CA3AF; }
  .status-btn span { font-size: 9px; font-weight: 700; color: #6B7280; }
  
  .status-btn.active.open { background: #DCFCE7; border-color: #86EFAC; }
  .status-btn.active.open i, .status-btn.active.open span { color: #166534; }
  .status-btn.active.rush { background: #FEE2E2; border-color: #FCA5A5; animation: pulse 2s infinite; }
  .status-btn.active.rush i, .status-btn.active.rush span { color: #991B1B; }
  @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);} 70% {box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);} }

  /* TABS */
  .tabs { display: flex; gap: 10px; padding: 15px 20px; overflow-x: auto; scrollbar-width: none; }
  .tab-pill { padding: 8px 16px; background: var(--white); border-radius: 30px; font-weight: 700; font-size: 13px; border: 1px solid #E5E7EB; cursor: pointer; white-space: nowrap; transition: 0.2s; }
  .tab-pill.active { background: var(--text); color: var(--white); border-color: var(--text); }

  /* ORDER CARD */
  .order-card { background: var(--white); padding: 18px; border-radius: 16px; margin: 0 20px 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 5px solid #ccc; position: relative; }
  .order-card.Pending { border-color: #F59E0B; }
  .order-card.Confirmed { border-color: #3B82F6; }
  .order-card.Completed { border-color: #10B981; }
  .o-header { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #E5E7EB; }
  .o-id { font-weight: 800; font-size: 16px; }
  .o-time { font-size: 12px; color: #6B7280; font-weight: 600; }
  .item-row { display: flex; justify-content: space-between; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #374151; }
  .item-qty { background: #F3F4F6; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 5px; }
  .o-actions { display: grid; grid-template-columns: 1fr 1fr 0.5fr 0.5fr; gap: 8px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
  .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
  .btn-acc { background: var(--text); color: white; grid-column: 1 / span 2; }
  .btn-ready { background: #3B82F6; color: white; grid-column: 1 / span 2; }
  .btn-icon { background: #F3F4F6; color: #4B5563; font-size: 18px; }

  /* MENU MANAGER (Updated) */
  .menu-item { background: var(--white); padding: 12px; border-radius: 12px; margin: 0 20px 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #E5E7EB; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .m-left { display: flex; align-items: center; gap: 12px; }
  .m-img { width: 50px; height: 50px; border-radius: 8px; background: #eee; object-fit: cover; }
  .m-name { font-weight: 700; font-size: 14px; display: block; color: #111; }
  .m-price { font-size: 12px; color: #6B7280; font-weight: 600; margin-top: 2px; }
  .stock-btn { padding: 6px 12px; border-radius: 6px; font-size: 10px; font-weight: 800; cursor: pointer; background: #FEE2E2; color: #991B1B; text-transform: uppercase; }
  .stock-btn.in { background: #DCFCE7; color: #166534; }

  /* FAB */
  .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 28px; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4); cursor: pointer; z-index: 100; transition: transform 0.2s; }
  .fab:active { transform: scale(0.9); }

  /* PRO MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-box { background: white; padding: 25px; width: 95%; max-width: 450px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-height: 90vh; overflow-y: auto; }
  
  .form-group { margin-bottom: 15px; }
  .form-label { display: block; font-size: 12px; font-weight: 700; color: #4B5563; margin-bottom: 5px; }
  .form-input { width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 10px; outline: none; font-size: 14px; background: #F9FAFB; transition: 0.2s; }
  .form-input:focus { border-color: var(--primary); background: #fff; }
  
  /* Image Upload */
  .img-upload-box { border: 2px dashed #D1D5DB; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; background: #F9FAFB; transition: 0.2s; position: relative; }
  .img-upload-box:hover { border-color: var(--primary); background: #EFF6FF; }
  .img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; display: none; margin-top: 10px; }
  
  /* Variants */
  .variant-row { display: grid; grid-template-columns: 2fr 1fr 30px; gap: 10px; margin-bottom: 8px; align-items: center; }
  .add-var-btn { font-size: 12px; color: var(--primary); font-weight: 700; cursor: pointer; display: inline-block; margin-top: 5px; }

  /* Save Btn */
  .save-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; margin-top: 20px; cursor: pointer; }
  .cancel-btn { width: 100%; padding: 12px; background: white; border: 1px solid #E5E7EB; color: #6B7280; font-weight: 700; border-radius: 12px; margin-top: 10px; cursor: pointer; }

  /* SECTIONS */
  .section { display: none; } .section.active { display: block; animation: fadeIn 0.3s; }
  @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
  
  /* Print */
  @media print { body * { visibility: hidden; } .print-area, .print-area * { visibility: visible; } .print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background: white; } }
</style>
</head>
<body>

  <script>
    const shop = JSON.parse(localStorage.getItem("vendor_user"));
    if(!shop) window.location.href = "vendor-login.html";
  </script>

  <div class="header">
    <div class="shop-info">
      <h2 id="shopName">...</h2>
      <span>Manager Panel</span>
    </div>
    <div class="controls">
      <div class="status-btn" id="rushBtn" onclick="toggleRush()"><i class='bx bxs-hot'></i> <span>RUSH</span></div>
      <div class="status-btn" id="openBtn" onclick="toggleStore()"><i class='bx bxs-store'></i> <span>OPEN</span></div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab-pill active" onclick="switchTab('orders')" id="taborders">Live Orders <span id="ordCount"></span></div>
    <div class="tab-pill" onclick="switchTab('menu')" id="tabmenu">Menu Manager</div>
    <div class="tab-pill" onclick="logout()" style="color:var(--red); border-color:var(--red);">Logout</div>
  </div>

  <div id="vieworders" class="section active">
    <div id="ordersList" style="padding-bottom: 80px;">
      <div style="text-align:center; padding:60px 20px; color:#9CA3AF;">
        <i class='bx bx-loader-alt bx-spin' style="font-size:30px;"></i><br><br>Checking for orders...
      </div>
    </div>
  </div>

  <div id="viewmenu" class="section">
    <div id="menuList" style="padding-bottom: 80px; padding-top:10px;"></div>
    <div class="fab" onclick="openAddModal()"><i class='bx bx-plus'></i></div>
  </div>

  <div class="modal-overlay" id="addModal">
    <div class="modal-box">
      <h2 style="font-size:18px; font-weight:800; margin-bottom:20px; color:#111;">Add New Item</h2>
      
      <div class="form-group">
        <label class="form-label">Item Name</label>
        <input id="newItemName" class="form-input" placeholder="e.g. Chicken Biryani">
      </div>

      <div class="form-group">
        <label class="form-label">Category</label>
        <select id="newItemCat" class="form-input">
          <option value="Starters">Starters</option>
          <option value="Main Course">Main Course</option>
          <option value="Biryani">Biryani</option>
          <option value="Fast Food">Fast Food</option>
          <option value="Drinks">Drinks</option>
          <option value="Desserts">Desserts</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Food Image</label>
        <div class="img-upload-box" onclick="document.getElementById('imgFile').click()">
          <span style="font-size:12px; color:#6B7280; font-weight:600;">Click to upload image</span>
          <input type="file" id="imgFile" style="display:none" accept="image/*" onchange="previewImage(this)">
          <img id="imgPreview" class="img-preview">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">VARIANTS</label>
        <div id="variantList">
          <div class="variant-row">
            <input class="form-input var-name" placeholder="Name (e.g. Half)" value="Regular">
            <input class="form-input var-price" type="number" placeholder="Price" value="">
            <i class='bx bxs-trash' style="color:#ccc;"></i>
          </div>
        </div>
        <div class="add-var-btn" onclick="addVariantRow()">+ Add Another Variant</div>
      </div>

      <button class="save-btn" onclick="saveItem()" id="saveBtn">Save Item</button>
      <button class="cancel-btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <div class="print-area" id="printArea" style="display:none;">
    <div style="text-align:center; font-family:monospace;">
      <h2 id="pTitle" style="margin:0;">KITCHEN TICKET</h2>
      <div style="border-bottom:2px dashed #000; margin:10px 0;"></div>
      <div id="pContent" style="text-align:left; font-size:14px; font-weight:700;"></div>
      <div style="border-top:2px dashed #000; margin:10px 0;"></div>
      <div id="pFooter" style="text-align:center; font-size:12px;"></div>
    </div>
  </div>

  <audio id="bell" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const app = initializeApp({ apiKey: "AIzaSyCuVtOv09ixwnZszRKxjq3PQtiDn3kE5ng", projectId: "tabey-foods" });
  const db = getFirestore(app);

  let isOnline = false, isRush = false, base64Img = "";
  document.getElementById("shopName").innerText = shop.name;

  // --- STORE STATUS ---
  onSnapshot(doc(db, "stores", shop.id), (d) => {
    if(d.exists()) {
      isOnline = d.data().isOnline; isRush = d.data().rushMode || false;
      const ob = document.getElementById("openBtn");
      isOnline ? ob.classList.add("active","open") : ob.classList.remove("active","open");
      const rb = document.getElementById("rushBtn");
      isRush ? rb.classList.add("active","rush") : rb.classList.remove("active","rush");
    }
  });
  window.toggleStore = async () => await updateDoc(doc(db, "stores", shop.id), { isOnline: !isOnline });
  window.toggleRush = async () => await updateDoc(doc(db, "stores", shop.id), { rushMode: !isRush });

  // --- ORDERS ---
  onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snap) => {
    const list = document.getElementById("ordersList");
    let html = ""; let count = 0;
    snap.forEach(d => {
      const o = d.data();
      const myItems = o.items ? o.items.filter(i => normalize(i.storeName) === normalize(shop.name)) : [];
      if(myItems.length > 0) {
        if(o.status !== "Completed" && o.status !== "Cancelled") count++;
        if(o.status === "Pending") document.getElementById("bell").play().catch(()=>{});
        
        const itemsHtml = myItems.map(i => `<div class="item-row"><span><span class="item-qty">${i.qty}</span> ${i.name} <small>(${i.variantLabel||'Reg'})</small></span><span>‚Çπ${i.price*i.qty}</span></div>`).join("");
        let btn = "";
        if(o.status==="Pending") btn=`<button class="btn btn-acc" onclick="setStatus('${d.id}','Confirmed')">Accept</button>`;
        else if(o.status==="Confirmed") btn=`<button class="btn btn-ready" onclick="setStatus('${d.id}','Out for Delivery')">Mark Ready</button>`;
        else btn=`<div style="grid-column:1/-1;text-align:center;padding:10px;background:#eee;border-radius:8px;font-weight:700">${o.status}</div>`;

        html += `<div class="order-card ${o.status}">
          <div class="o-header"><span class="o-id">#${d.id.slice(0,4)} <span style="font-weight:400">‚Ä¢ ${o.customer.name}</span></span><span class="o-time">${new Date(o.timestamp?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>
          <div class="o-items">${itemsHtml}</div>
          <div class="o-actions">${btn}<button class="btn btn-icon" onclick="printSlip('KOT','${d.id}','${o.customer.name}','${itemsHtml.replace(/"/g,"'")}')"><i class='bx bx-dish'></i></button></div>
        </div>`;
      }
    });
    document.getElementById("ordCount").innerText = count > 0 ? `(${count})` : "";
    list.innerHTML = html || `<div style="text-align:center;padding:50px;color:#999">No active orders</div>`;
  });

  // --- MENU ---
  onSnapshot(query(collection(db, "menu")), (snap) => {
    const list = document.getElementById("menuList");
    let html = "";
    snap.forEach(d => {
      const i = d.data();
      if(normalize(i.storeName) === normalize(shop.name)) {
        const p = i.variants ? `‚Çπ${i.variants[0].price}` : `‚Çπ${i.price}`;
        const vCount = i.variants && i.variants.length > 1 ? `<span style="font-size:10px;background:#eee;padding:2px 5px;border-radius:4px;margin-left:5px;">+${i.variants.length-1} var</span>` : "";
        
        html += `<div class="menu-item" style="opacity:${i.inStock?1:0.6}">
          <div class="m-left"><img src="${i.img||'https://via.placeholder.com/150'}" class="m-img"><div><span class="m-name">${i.name} ${vCount}</span><span class="m-price">${p}</span></div></div>
          <div style="display:flex;align-items:center;gap:10px;"><div class="stock-btn ${i.inStock?'in':''}" onclick="toggleStock('${d.id}',${i.inStock})">${i.inStock?'IN':'OUT'}</div><i class='bx bxs-trash' style="color:#ef4444;cursor:pointer" onclick="delItem('${d.id}')"></i></div>
        </div>`;
      }
    });
    list.innerHTML = html || `<div style="text-align:center;padding:40px;color:#999">Menu empty.</div>`;
  });

  // --- PRO MODAL FUNCTIONS ---
  window.previewImage = (input) => {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = (e) => {
        // Simple Image Compression via Canvas
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const maxWidth = 300; // Resize to 300px width max
          const scale = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scale;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          base64Img = canvas.toDataURL('image/jpeg', 0.7); // Compress quality 0.7
          
          document.getElementById('imgPreview').src = base64Img;
          document.getElementById('imgPreview').style.display = 'block';
        };
      };
      reader.readAsDataURL(input.files[0]);
    }
  };

  window.addVariantRow = () => {
    const div = document.createElement("div");
    div.className = "variant-row";
    div.innerHTML = `<input class="form-input var-name" placeholder="Name (e.g. Full)"><input class="form-input var-price" type="number" placeholder="Price"><i class='bx bxs-trash' style="color:#EF4444; cursor:pointer;" onclick="this.parentElement.remove()"></i>`;
    document.getElementById("variantList").appendChild(div);
  };

  window.saveItem = async () => {
    const btn = document.getElementById("saveBtn");
    btn.innerText = "Saving..."; btn.disabled = true;

    const name = document.getElementById("newItemName").value.trim();
    const cat = document.getElementById("newItemCat").value;
    
    // Collect Variants
    const variants = [];
    document.querySelectorAll(".variant-row").forEach(row => {
      const vName = row.querySelector(".var-name").value.trim();
      const vPrice = Number(row.querySelector(".var-price").value);
      if(vName && vPrice) variants.push({ label: vName, price: vPrice });
    });

    if(!name || variants.length === 0) { alert("Add name and at least 1 variant price"); btn.innerText="Save Item"; btn.disabled=false; return; }

    try {
      await addDoc(collection(db, "menu"), {
        name, category: cat, storeName: shop.name,
        variants, img: base64Img || "https://via.placeholder.com/150",
        inStock: true, price: variants[0].price // fallback
      });
      closeModal();
    } catch(e) { console.error(e); alert("Error saving item"); }
    btn.innerText = "Save Item"; btn.disabled = false;
  };

  // --- UTILS ---
  const normalize = (s) => (s||"").toLowerCase().replace(/[^a-z0-9]/g,"");
  window.setStatus = async (id, s) => await updateDoc(doc(db,"orders",id),{status:s});
  window.toggleStock = async (id, s) => await updateDoc(doc(db,"menu",id),{inStock:!s});
  window.delItem = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,"menu",id)); };
  window.openAddModal = () => document.getElementById("addModal").style.display = 'flex';
  window.closeModal = () => document.getElementById("addModal").style.display = 'none';
  window.switchTab = (t) => {
    document.querySelectorAll(".section").forEach(e=>e.classList.remove("active"));
    document.querySelectorAll(".tab-pill").forEach(e=>e.classList.remove("active"));
    document.getElementById("view"+t).classList.add("active");
    document.getElementById("tab"+t).classList.add("active");
  };
  window.logout = () => { localStorage.removeItem("vendor_user"); location.href="vendor-login.html"; };
  
  // Print Logic
  window.printSlip = (type,id,name,html) => {
    const area=document.getElementById("printArea");
    document.getElementById("pTitle").innerText = type==="KOT"?"üßë‚Äçüç≥ KITCHEN TICKET":"üßæ RECEIPT";
    document.getElementById("pContent").innerHTML = `Order #${id.slice(0,4)}<br>${name}<br><br>${html}`;
    document.getElementById("pFooter").innerHTML = "<br>"+new Date().toLocaleString();
    area.style.display="block"; window.print(); setTimeout(()=>area.style.display="none",1000);
  };
</script>
</body>
</html>
